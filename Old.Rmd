---
title: "Old"
author: "Marco Villotta"
date: "2023-06-14"
output: html_document
---



ccn2 %>%
  inner_join(good %>%
               inner_join(down)
             ) %>%
  filter(conductorName == "Bernstein, Leonard") %>%

  ggplot() +
  geom_point(aes(seasonYear,perc,color=composerName), show.legend = FALSE) +
  facet_wrap(~conductorName)

ccn2_nested_models <- ccn2_nested %>%
  mutate(models = map(data, ccn2_func))

ccn2_nested_models_glance <- ccn2_nested_models %>%
  mutate(glance = map(models,glance))

ccn2_glance <- unnest(ccn2_nested_models_glance, glance, names_sep = "_")

ccn2_glance %>%
  filter(glance_adj.r.squared != 1) %>%
  arrange(-glance_adj.r.squared)

ccn2_glance_slopes <- ccn2_glance %>%
  mutate(models = map(models, tidy)) %>% 
  unnest(cols = c(models)) %>%
  filter(term == "seasonYear_2")

ccn2_glance <- ccn2_glance %>%
  mutate(data = map2(data, models, add_residuals))

ccn2_glance %>%
  unnest(data) %>%
  filter(conductorName == "Walter, Bruno") %>%
  ggplot(aes(seasonYear,resid,color=composerName)) +
  geom_line(show.legend = FALSE)

ccn2 %>%
  filter(conductorName == "Walter, Bruno") %>%
  ggplot(aes(seasonYear,perc,color=composerName)) +
  geom_line(show.legend = FALSE)

  int <- ccn2_glance_slopes %>%
  unnest(data) %>%
  mutate(n = n()) %>%
  filter(n >= 8) %>%
  filter(glance_adj.r.squared != 1 & glance_adj.r.squared > 0.75) %>%
  arrange(estimate) %>%
  distinct(conductorName, composerName, glance_adj.r.squared)

top_slopes <- slopes %>%
  filter(adjusted.p.value < 0.05)
```

```{r} 
ccn2 %>%
  filter(composerName == "Gershwin, George") %>%
  filter(conductorName == "Bernstein, Leonard") %>%
  ggplot(aes(seasonYear,perc)) +
  geom_point()

```



















Come si sono evoluti i repertori dei conduttori?

```{r}
ccn_inv <- performances %>%
  mutate(conductorName = if_else(is.na(conductorName),"NoName",conductorName)) %>%
  count(seasonYear,composerName,conductorName) %>%
  group_by(seasonYear,composerName) %>%
  mutate(composerYear = sum(n)) %>%
  rename(conductorComposerYear = n) %>%
  ungroup()

ccn_inv_nested <- ccn_inv %>%
  group_by(composerName,conductorName) %>%
  nest()

ccn_inv_nested_models <- ccn_inv_nested %>%
  mutate(models = map(data, ~ glm(cbind(conductorComposerYear, composerYear) ~ seasonYear, ., family = "binomial")))

ccn_inv_nested_models_glance <- ccn_inv_nested_models %>%
  mutate(glance = map(models,glance))

good <- ccn_inv_nested_models_glance %>%
  unnest(glance) %>%
  select(composerName,conductorName,null.deviance,deviance) %>%
  filter(null.deviance > 0) %>%
  mutate(rsq = 1 - (deviance / null.deviance)) %>%
  filter(rsq >= 0.7 & rsq < 1) %>%
  arrange(-rsq) %>%
  select(composerName,conductorName)

slopes <- ccn_inv_nested_models %>%
  mutate(models = map(models, tidy)) %>% 
  unnest(cols = c(models)) %>%
  filter(term == "seasonYear") %>%
  mutate(adjusted.p.value = p.adjust(p.value)) %>%
  filter(conductorName != "NoName") %>%
  filter(adjusted.p.value < 0.05) %>%
  unnest(data) %>%
  mutate(n = n()) %>%
  filter(n >= 4)

slopes %>%
  inner_join(good)

up_slopes <- slopes %>%
  filter(estimate > 0) %>%
  arrange(-estimate)

down_slopes <- slopes %>%
  filter(estimate < 0) %>%
  arrange(estimate)
```



```{r}
ccn_inv %>%
  inner_join(slopes %>%
  inner_join(good)) %>%
  ggplot(aes(seasonYear, conductorComposerYear / composerYear, color = conductorName)) +
  geom_line() +
  facet_wrap(~composerName)
```

```{r}
ccn_inv %>%
  inner_join(up_slopes) %>%
  ggplot(aes(seasonYear, conductorComposerYear / composerYear, color = conductorName)) +
  geom_point() +
  facet_wrap(~composerName)
```

```{r}
ccn_inv %>%
  inner_join(up_slopes) %>%
  filter(composerName == "Wagner, Richard") %>%
  ggplot(aes(seasonYear, conductorComposerYear / composerYear, color = conductorName)) +
  geom_point() +
  geom_line()
```


```{r}
ccn_inv %>%
  inner_join(up_slopes) %>%
  filter(composerName == "Beethoven, Ludwig van") %>%
  ggplot(aes(seasonYear, conductorComposerYear / composerYear, color = conductorName)) +
  geom_point() +
  geom_line()
```













Compositori che sono particolarmente rappresentati in un certo mese.
Globalmente, considerando i lavori rappresentati, sulla base della percentuale all'interno del mese.

```{r}
performances %>%
  filter(season > 1909) %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(composerName) %>%
  mutate(totalC = n()) %>%
  group_by(composerName,month,monthid) %>%
  mutate(totalM = n()) %>%
  mutate(percent = totalM / totalC) %>%
  distinct(composerName,month,percent) %>%
  filter(composerName == "Gershwin, George")
  inner_join(over40) %>%
  ggplot() +
    geom_tile(aes(x=reorder(month,monthid),y=composerName,fill=percent)) +
    scale_fill_viridis_c(option = "magma")
```

```{r}
# mesi
perf_data <- performances %>%
  filter(season > 1909) %>%
  mutate(month = month(Date, label = TRUE)) %>%
  group_by(composerName,year,month) %>%
  mutate(monthP_Y = n()) %>%
  group_by(composerName,year) %>%
  mutate(yearP = n()) %>%
  mutate(perc = monthP_Y / yearP) %>%
  group_by(composerName) %>%
  filter(composerName == "Gershwin, George") %>%
  distinct(seasonYear,month,perc) %>%
  ungroup()



  mutate(months = n_distinct(month)) %>%
  filter(months == 12) %>%
  select(composerName,conductorName,year,month,perc) %>%
    ggplot() +
    geom_tile(aes(x=month,y=composerName,fill=perc)) +
    scale_fill_viridis_c(option = "magma")
  
  

regs <- perf_data %>%
  mutate(
    fit = map(data, ~ lm(perc ~ month, data = .x)),
    tidied = map(fit, tidy),
    glanced = map(fit, glance),
    augmented = map(fit, augment)
  )

mod <- lm(perc ~ month, data = perf_data)

grid <- perf_data %>% 
  add_predictions(mod, "percpred") %>%
  add_residuals(mod)



daily %>%
  arrange(-resid)

regs %>%
  unnest(glanced) %>%
  unnest(tidied, names_sep = "_") %>%
  arrange(-r.squared,-tidied_estimate)
```

```{r}
performances %>%
  filter(season > 1909) %>%
  mutate(month = month(Date, label = TRUE)) %>%
  group_by(composerName,year,month) %>%
  mutate(monthP_Y = n()) %>%
  group_by(composerName,year) %>%
  mutate(yearP = n()) %>%
  group_by(composerName) %>%
  mutate(months = n_distinct(month)) %>%
  filter(months == 12) %>%
  select(eventType,composerName,Date,conductorName,year,month,monthP_Y,yearP) %>%
  filter(composerName == "Musorgsky, Modest") %>%
  filter(conductorName == "DePreist, James") %>%
  ggplot() +
  geom_point(aes(year, monthP_Y))
```
















```{r}
ccn <- performances %>%
  mutate(conductorName = if_else(is.na(conductorName),"NoName",conductorName)) %>%
  count(seasonN,conductorName,composerName) %>%
  group_by(conductorName,seasonN) %>%
  mutate(totalT = sum(n)) %>%
  rename(conductorT = n) %>%
  ungroup()

ccn_nested <- ccn %>%
  group_by(conductorName,composerName) %>%
  nest()

ccn_nested_models <- ccn_nested %>%
  mutate(models = map(data, ~ glm(cbind(conductorT, totalT) ~ seasonN, ., family = "binomial")))

ccn_nested_models_glance <- ccn_nested_models %>%
  mutate(glance = map(models,glance))

slopes <- ccn_nested_models %>%
  mutate(models = map(models, tidy)) %>% 
  unnest(cols = c(models)) %>%
  filter(term == "seasonN") %>%
  mutate(adjusted.p.value = p.adjust(p.value))

top_slopes <- slopes %>%
  filter(adjusted.p.value < 0.05)
```

Prendo quelle che contengono almeno5 osservazioni.

```{r}
over5 <- top_slopes %>%
  unnest(data) %>%
  mutate(n = n()) %>%
  filter(n >= 5) %>%
  distinct(conductorName,composerName,estimate)
```

Le plotto.

```{r}
ccn %>%
  inner_join(over5) %>%
  ggplot(aes(seasonN, conductorT / totalT, color=composerName)) +
  geom_line(show.legend = FALSE) +
  facet_wrap(~conductorName)
```

```{r}
ccn %>%
  inner_join(over5) %>%
  filter(conductorName == "Walter, Bruno") %>%
  ggplot(aes(seasonN, conductorT / totalT, color=composerName)) +
  geom_line(alpha = 1/3, show.legend = TRUE) +
  geom_point(alpha = 1/3, show.legend = TRUE)
  ```


```{r}
ccn %>%
  inner_join(over10) %>%
  filter(conductorName == "Bernstein, Leonard") %>%
  filter(estimate < 0) %>%
  ggplot(aes(seasonN, conductorT / totalT, color=composerName)) +
  geom_line(show.legend = TRUE)
```

```{r}
ccn %>%
  anti_join(over10) %>%
  filter(conductorName == "Stransky, Josef") %>%
  ggplot(aes(seasonN, conductorT / totalT, color=composerName)) +
  geom_line(alpha = 1/3, show.legend = FALSE) +
  geom_point(alpha = 1/3, show.legend = FALSE)
```

```{r}
ccn %>%
  anti_join(over10) %>%
  filter(conductorName == "Bernstein, Leonard") %>%
  arrange(estimate)
```









```{r}

  
  performances %>%
  filter(seasonYear > 1909) %>%
  filter(composerName == "Gershwin, George") %>%
  mutate(month = month(Date)) %>%
  ggplot() +
  geom_bar(aes(month))

monthly <-  performances %>%
  filter(seasonYear > 1909) %>%
  filter(composerName == "Wagner, Richard") %>%
  mutate(month = month(Date)) %>%
  group_by(year,month) %>%
  summarise(n = n())

mod <- lm(n ~ month, data = monthly)

monthly %>%
  add_predictions(mod, "n_pred") %>%
  add_residuals(mod) %>%
  ggplot() +
  geom_point(aes(year,month,color=resid))

  group_by(Date) %>%
  summarise(n = n())
daily

ggplot(daily, aes(Date, n)) + 
  geom_line()

daily <- daily %>% 
  mutate(month = month(Date, label = TRUE))
ggplot(daily, aes(month, n)) + 
  geom_boxplot()

mod <- lm(n ~ month, data = daily)

grid <- daily %>% 
  data_grid(month) %>% 
  add_predictions(mod, "n")

ggplot(daily, aes(month, n)) + 
  geom_boxplot() +
  geom_point(data = grid, colour = "red", size = 4)

daily <- daily %>% 
  add_residuals(mod)
daily %>% 
  ggplot(aes(Date, resid)) + 
  geom_ref_line(h = 0) + 
  geom_line() +
  geom_smooth()

daily %>%
  filter(resid > 4) %>%
ggplot(aes(Date, resid, colour = month)) + 
  geom_ref_line(h = 0) + 
  geom_point()

performances %>%
  filter(seasonYear > 1909) %>%
  filter(composerName == "Gershwin, George")


```


```{r}
conductors <- tibble(conductorName = c("Seidl, Anton", "Paur, Emil", "Damrosch, Walter", "Safonoff, Wassily", "Mahler, Gustav", "Stransky, Josef", "Mengelberg, Willem", "Toscanini, Arturo"))

composers <- tibble(composerName = c("Wagner, Richard"))

ccn %>%
  inner_join(
    slopes %>%
    inner_join(wagnerOverTwo)
    ) %>%
  ggplot(aes(seasonN, conductorT / totalT, color = composerName)) +
  geom_line(show.legend = TRUE) +
  facet_wrap(~conductorName)

ccn %>%
  inner_join(
    slopes %>%
      inner_join(conductors) %>%
    inner_join(composers)
    ) %>%
  ggplot(aes(seasonN, conductorT / totalT, color = composerName)) +
  geom_line(show.legend = TRUE) +
  facet_wrap(~conductorName)

wagnerOverTwo <- slopes %>%
  unnest(data) %>%
  filter(composerName == "Wagner, Richard") %>%
  count() %>%
  filter(n >= 3)


```

Come si sono evoluti i repertori dei conduttori?

```{r}
ccn2 <- performances %>%
  mutate(conductorName = if_else(is.na(conductorName),"NoName",conductorName)) %>%
  count(seasonYear,conductorName,composerName) %>%
  group_by(conductorName,seasonYear) %>%
  mutate(totalT = sum(n)) %>%
  rename(conductorT = n) %>%
  ungroup()

ccn2 <- ccn2 %>%
  mutate(perc = conductorT / totalT) %>%
  mutate(seasonYear_2 = seasonYear**2)

ccn2_nested <- ccn2 %>%
  group_by(conductorName,composerName) %>%
  nest()

ccn2_func <- function(df) {
  lm(perc ~ seasonYear + seasonYear_2, data = df)
}

ccn2_nested_models <- ccn2_nested %>%
  mutate(models = map(data, ccn2_func))

ccn2_nested_models_glance <- ccn2_nested_models %>%
  mutate(glance = map(models,glance))

ccn2_glance <- unnest(ccn2_nested_models_glance, glance, names_sep = "_")

ccn2_glance %>%
  filter(glance_adj.r.squared != 1) %>%
  arrange(-glance_adj.r.squared)

ccn2_glance_slopes <- ccn2_glance %>%
  mutate(models = map(models, tidy)) %>% 
  unnest(cols = c(models)) %>%
  filter(term == "seasonYear_2")

ccn2_glance <- ccn2_glance %>%
  mutate(data = map2(data, models, add_residuals))

ccn2_glance %>%
  unnest(data) %>%
  filter(conductorName == "Walter, Bruno") %>%
  ggplot(aes(seasonYear,resid,color=composerName)) +
  geom_line(show.legend = FALSE)

ccn2 %>%
  filter(conductorName == "Walter, Bruno") %>%
  ggplot(aes(seasonYear,perc,color=composerName)) +
  geom_line(show.legend = FALSE)

  int <- ccn2_glance_slopes %>%
  unnest(data) %>%
  mutate(n = n()) %>%
  filter(n >= 8) %>%
  filter(glance_adj.r.squared != 1 & glance_adj.r.squared > 0.75) %>%
  arrange(estimate) %>%
  distinct(conductorName, composerName, glance_adj.r.squared)

top_slopes <- slopes %>%
  filter(adjusted.p.value < 0.05)
```

```{r}
ccn2 %>%
  inner_join(int) %>%
  ggplot(aes(seasonYear, conductorT / totalT, color=composerName)) +
  geom_point(show.legend = FALSE) +
  geom_line(show.legend = FALSE) +
  facet_wrap(~conductorName)
```



```{r}
ccn_inv <- performances %>%
  mutate(conductorName = if_else(is.na(conductorName),"NoName",conductorName)) %>%
  count(seasonN,composerName,conductorName) %>%
  group_by(seasonN,conductorName) %>%
  mutate(totalT = sum(n)) %>%
  rename(conductorT = n) %>%
  ungroup()

ccn_inv_nested <- ccn_inv %>%
  group_by(composerName,conductorName) %>%
  nest()

ccn_inv_nested_models <- ccn_inv_nested %>%
  mutate(models = map(data, ~ glm(cbind(conductorT, totalT) ~ seasonN, ., family = "binomial")))

ccn_inv_nested_models_glance <- ccn_inv_nested_models %>%
  mutate(glance = map(models,glance))

ccn_inv_slopes <- ccn_inv_nested_models %>%
  mutate(models = map(models, tidy)) %>% 
  unnest(cols = c(models)) %>%
  filter(term == "seasonN") %>%
  mutate(adjusted.p.value = p.adjust(p.value))

ccn_inv_top_slopes <- ccn_inv_slopes %>%
  filter(adjusted.p.value < 0.05)

inv <- ccn_inv_top_slopes %>%
  unnest(data) %>%
  mutate(n = n()) %>%
  filter(n >= 8) %>%
  filter(estimate < 0) %>%
  arrange(estimate)
```

```{r}
ccn_inv %>%
  inner_join(inv) %>%
  ggplot(aes(seasonN, conductorT / totalT, color = composerName)) +
  geom_point(show.legend = FALSE) +
  geom_line(show.legend = FALSE) +
  facet_wrap(~conductorName)
```
















Stagioni fra 50 e 80.

```{r}
seasons0_100 <- top_slopes %>%
  unnest(data) %>%
  filter(conductorName != "NoName") %>%

  mutate(count = n()) %>%
  filter(count >= 5) %>%
  arrange(estimate) %>%
  distinct(conductorName,composerName,estimate)
```


```{r}
ccn %>%
  inner_join(int) %>%
  ggplot(aes(seasonN, conductorT / totalT, color=composerName)) +
  geom_point(show.legend = FALSE) +
  geom_line(show.legend = FALSE) +
  facet_wrap(~conductorName)
```



```{r}
ccn %>%
  filter(conductorName == "Schelling, Ernest") %>%
  ggplot(aes(seasonN, conductorT / totalT, color=composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point(show.legend = FALSE)
```


```{r}
ccn %>%
  anti_join(int) %>%
  filter(conductorName == "Bernstein, Leonard") %>%
  ggplot(aes(seasonN, conductorT / totalT, color=composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point(show.legend = FALSE) +
  stat_smooth(se=F, method='lm', formula=y~poly(x,2),show.legend = FALSE)
```


```{r}
ccn %>%
  filter(composerName == "Wagner, Richard") %>%
  ggplot() +
  geom_histogram(aes(seasonN,fill=conductorName,binwidth=1), show.legend = FALSE)
```



Gini conduttori.

```{r}
gini_cond <- performances %>%
  group_by(seasonN,conductorName) %>%
  mutate(conductorPerformances = n()) %>%
  group_by(seasonN) %>%
  mutate(seasonPerformances = n()) %>%
  ungroup() %>%
  distinct(seasonN,conductorName,conductorPerformances,seasonPerformances) %>%
  select(seasonN,conductorPerformances) %>%
  group_by(seasonN) %>%
  mutate(gini = Gini(conductorPerformances)) %>%
  distinct(seasonN,gini)
  
ggplot(gini_cond) +
    geom_line(aes(seasonN,gini))
```

```{r}
ccn %>%
  mutate(perc = conductorT / totalT) %>%
  group_by(composerName) %>%
  mutate(seasons = n_distinct(seasonN)) 
  mutate(mod = lm(perc ~ conductorName + seasonN))
```




















Come si sono evoluti i repertori dei conduttori?

```{r}
ccn <- performances %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  group_by(seasonN,conductorName,composerName) %>%
  mutate(compSeason = n()) %>%
  group_by(seasonN,conductorName) %>%
  mutate(condSeason = n()) %>%
  ungroup()

ccn_rid <- ccn %>%
  distinct(seasonN,conductorName,composerName,compSeason,condSeason)

ccn_rid_n <- ccn_rid %>%
  group_by(conductorName,composerName) %>%
  nest()

ccn_rid_n_models <- ccn_rid_n %>%
  mutate(models = map(data, ~ glm(cbind(compSeason, condSeason) ~ seasonN, ., family = "binomial")))

slopes <- ccn_rid_n_models %>%
  mutate(models = map(models, tidy)) %>% 
  unnest(cols = c(models)) %>%
  filter(term == "seasonN") %>%
  mutate(adjusted.p.value = p.adjust(p.value))

goodslopes <- slopes %>%
  filter(adjusted.p.value < 0.05)
```

Costruisco un elenco di direttori - compositori (tempo fra prima e ultima rappresentazione di quel compositore da parte di quel direttore).

```{r}
spans <- performances %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  group_by(conductorName,composerName) %>%
  mutate(
    min = min(seasonN),
    max = max(seasonN),
    span = max - min + 1
  ) %>%
  distinct(conductorName,composerName,span)
```

Seleziono alcuni modelli che hanno pendenza positiva. Per farlo mi concentro su quelli che hanno uno span di più di 10 anni.

```{r}
totalup <- slopes %>%
  filter(estimate > 0)

upslopes <- slopes %>%
  filter(adjusted.p.value < 0.05) %>%
  filter(estimate > 0) %>%
  inner_join(spans) %>%
  filter(span > 10) %>%
  arrange(-span) %>%
  head(20)

ccn_rid %>%
  inner_join(upslopes) %>%
  ggplot(aes(seasonN,compSeason / condSeason,color=composerName)) +
  geom_line() +
  facet_wrap(~conductorName)
```

Similmente con quelli che hanno pendenza negativa.

```{r}
totaldown <- slopes %>%
  filter(estimate < 0)

downslopes <- slopes %>%
  filter(adjusted.p.value < 0.05) %>%
  filter(estimate < 0) %>%
  inner_join(spans) %>%
  filter(span > 10) %>%
  arrange(-span) %>%
  head(20)

ccn_rid %>%
  inner_join(downslopes) %>%
  ggplot(aes(seasonN,compSeason / condSeason,color=composerName)) +
  geom_line() +
  facet_wrap(~conductorName)
```

Bernstein.

```{r}
ccn_rid %>%
  inner_join(upslopes) %>%
  filter(conductorName == "Bernstein, Leonard") %>%
  ggplot(aes(seasonN,compSeason / condSeason,color = composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point() +
  facet_wrap(~composerName)
```

Bernstein downslopes.

```{r}
ccn_rid %>%
  inner_join(downslopes) %>%
  filter(conductorName == "Bernstein, Leonard") %>%
  ggplot(aes(seasonN,compSeason / condSeason,color = composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point() +
  facet_wrap(~composerName)
```

Maazel.

```{r}
ccn_rid %>%
  inner_join(downslopes) %>%
  filter(conductorName == "Maazel, Lorin") %>%
  ggplot(aes(seasonN,compSeason / condSeason,color = composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point() +
  facet_wrap(~composerName)
```


```{r}
ccn_rid %>%
  filter(conductorName == "Mahler, Gustav") %>%
  filter(composerName == "Wagner, Richard") %>%
  ggplot(aes(seasonN,compSeason / condSeason,color = composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point() +
  facet_wrap(~composerName)
```




```{r}
meancarr <- ccn %>%
  mutate(seasonN_2 = seasonN**2) %>%
  group_by(conductorName) %>%
  mutate(seasons = n_distinct(seasonN)) %>%
  filter(seasons > 1) %>%
  group_by(conductorName,seasonN) %>%
  mutate(median = median(conductorT/totalT)) %>%
  group_by(conductorName) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ lm(median ~ seasonN + seasonN_2, data = .x)),
    tidied = map(fit, tidy),
    glanced = map(fit, glance),
    augmented = map(fit, augment)
  ) %>%
  unnest(glanced) %>%
  filter(r.squared < 1) %>%
  arrange(-r.squared) %>%
  head(10)
```

```{r}
ccn %>%
  inner_join(meancarr) %>%
  ggplot() +
  geom_point(aes(seasonN,median))
```





```{r}
composersf <- function(df) {
  lm(composers ~ seasonYear + seasonYear_2, data = df)
}

composerNumber <- performances %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  group_by(conductorName) %>%
  mutate(seasons = n_distinct(seasonYear)) %>%
  filter(seasons > 5) %>%
  group_by(conductorName, seasonYear) %>%
  mutate(composers = n_distinct(composerName)) %>%
  distinct(seasonYear,conductorName,composers) %>%
  mutate(seasonYear_2 = seasonYear**2)

composerNumber %>%
  group_by(conductorName) %>%
  nest() %>%
  mutate(model = map(data, composersf)) %>%
  mutate(tidied = map(model, tidy)) %>%
  mutate(glance = map(model, glance))

crescenti <- regs %>%
  unnest(tidied) %>%
  filter(term == "seasonYear") %>%
  filter(estimate > 0) %>%
  arrange(-estimate)
  
decrescenti <- regs %>%
  unnest(tidied) %>%
  filter(term == "seasonYear") %>%
  filter(estimate < 0) %>%
  arrange(estimate)
  
composerNumber %>%
  inner_join(badfit) %>%
  ggplot(aes(seasonYear,composers, color = conductorName)) +
  geom_line(show.legend = FALSE)  
  
badfit <- regs %>%
  unnest(glance) %>%
  filter(r.squared < 0.5)

```




























































































































```{r}
tolto sta roba


# mesi
perf_data <- performances %>%
  mutate(month = month(Date, label = TRUE)) %>%
  group_by(composerName,year,month) %>%
  mutate(monthP_Y = n()) %>%
  group_by(composerName,year) %>%
  mutate(yearP = n()) %>%
  group_by(composerName) %>%
  mutate(months = n_distinct(month)) %>%
  filter(months == 12) %>%
  select(eventType,composerName,Date,conductorName,year,month,monthP_Y,yearP) %>%
  group_by(composerName)

regs <- perf_data %>%
  nest() %>%
  mutate(
    fit = map(data, ~ lm(monthP_Y ~ conductorName + eventType, data = .x)),
    tidied = map(fit, tidy),
    glanced = map(fit, glance),
    augmented = map(fit, augment)
  )
```









```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


vecchia cosa per date e time

```{r}
programsT %>% separate(Date, into = c("date", "time"), sep = "T") %>%
  count(time)

# elimino time perché non è attendibile
prova %>%
  separate(Date, into = c("date", "time"), sep = "T") %>%
  unite(new, date, Time, sep = " ") %>%
  select(-time) %>%
  mutate(Date = parse_date_time(new, "%y-%m-%d %H:%M%p")) %>%
  select(-new) %>%
  select(id, programID, orchestra, season, eventType, Location, Venue, Date, everything())
# attenzione al warning

programsT %>%
  mutate(date = sapply(Date,function (x) str_extract(x, "[[:digit:]-]+")))

programsT %>%
  mutate(dt = str_extract(programsT$Date, "[[:digit:]-]+")) %>%
  mutate(dtt = str_c(dt, " ", programsT$Time)) %>%
  mutate(dateTime = parse_date_time(dtt, "%y-%m-%d %I:%M%p"))

programsT %>%
  mutate(dt = str_extract(programsT$Date, "[[:digit:]-]+")) %>%
  mutate(date = parse_date(dt)) 


  mutate(dtt = str_c(dt, " ", programsT$Time)) %>%
  mutate(dateTime = parse_date_time(dtt, "%y-%m-%d %I:%M%p"))


str_extract(x, "[[:digit:]-]+")

length(str_extract(programsT$Date, "\\d+-\\d+-\\d+"))
str_extract("1842-12-07T05:00:00Z", "[[:digit:]-]+")
as_datetime("1842-12-07 8:00PM")

length(str_extract(programsT$Time, "\\d+:\\d+PM"))
str_extract("8:00PM", "PM")
is.na(programsT$Time)
length(programsT$Date
       
       )

sum(is.na(c(NA,NA,3)))


programsT <- programsT %>%
  mutate(Time = str_replace(Time, "None", "")) %>%
  mutate(Date = str_c(str_extract(Date, "[[:digit:]-]+"),Time)) %>%
  mutate(Date = parse_date_time(Date, c("%y-%m-%d %I:%M%p","%y-%m-%d"))) %>%
  select(programID, orchestra, season, eventType, Location, Venue, Date, Time, ID, composerName, workTitle, conductorName, soloistName, soloistInstrument, soloistRoles, movement, interval)
```



Cerco di capire che cosa contengono.

```{r}
works <- programsT %>%
  mutate(works_L = sapply(works, length)) %>%
  filter(works_L == 3) %>%
  mutate(works_N = lapply(works, names)) %>%
  pull(works_N)

first <- works[[1]]

identical_to_first <- lapply(works, identical, first)

works4 <- programsT %>%
  mutate(works_L = sapply(works, length)) %>%
  filter(works_L == 4) %>%
  mutate(works_N = lapply(works, names)) %>%
  pull(works_N)

works4_first <- works4[[1]]
id_to_first_w4 <- lapply(works4, identical, works4_first)
every(id_to_first_w4, isTRUE)

works5 <- programsT %>%
  mutate(works_L = sapply(works, length)) %>%
  filter(works_L == 5) %>%
  mutate(works_N = lapply(works, names)) %>%
  pull(works_N)

works5_first <- works5[[1]]
id_to_first_w5 <- lapply(works5, identical, works5_first)
every(id_to_first_w5, isTRUE)
detect_index(id_to_first_w5, isFALSE)
works5[[18]]
length(id_to_first_w5)
sum(unlist(id_to_first_w5))

works6 <- programsT %>%
  mutate(works_L = sapply(works, length)) %>%
  filter(works_L == 6) %>%
  mutate(works_N = lapply(works, names)) %>%
  pull(works_N)

works6_first <- works6[[1]]
id_to_first_w6 <- lapply(works6, identical, works6_first)
every(id_to_first_w6, isTRUE)

```

Faccio unnest_wider di works, controllo di aver mantenuto le informazioni di partenza.

```{r}
programsT <- programsT %>% mutate(works_L = sapply(works, length))
prova <- programsT %>% unnest_wider(works)
prova %>% filter(works_L == 3) # deve essere 18489
prova %>% filter(works_L == 4)
prova %>% filter(works_L == 5)
prova %>% filter(works_L == 6)
prova %>% filter(!is.na(conductorName))
prova
```

Controllo la lunghezza delle liste contenute in soloists.

```{r}
# da fare meglio
```

Faccio unnest_longer() su solisti e quindi unnest_wider().

```{r}
prova <- unnest_longer(prova, soloists, keep_empty = TRUE) # spiegare perché
prova <- unnest_wider(prova, soloists) # aumento da 17 a 19 le colonne ? e mi sono anche sistemato il problema del NULL
```

Verifico la lunghezza degli elementi contenuti in movement. Ci sono 148 elementi che hanno lunghezza 2.

```{r}
prova %>%
  mutate(movement_L = sapply(movement, length)) %>%
  count(movement_L)
```

Guardo a quelli che hanno lunghezza 2.

```{r}
prova %>%
  mutate(movement_L = sapply(movement, length)) %>%
  filter(movement_L == 2)
```





Applico funzione per sistemarli

```{r}
mod_w <- function(x) {
  if (is.null(x)) return (NA)
  if (length(x) == 1) return (x[[1]])
  if (length(x) == 2) return (combine_w(x[[1]], x[[2]]))
}

combine_w <- function(x,y) {
  if (startsWith(x,",")) {
    return (paste(y,x))
  } else {
    return (paste(x,y))
  }
}

prova <- prova %>% mutate(workTitle = sapply(workTitle, mod_w))

prova %>%
  filter(str_detect(workTitle, "PROCESSION"))
```

Correggo come è scritta la data.

```{r}
prova %>% separate(Date, into = c("date", "time"), sep = "T") %>%
  count(time)

# elimino time perché non è attendibile
prova %>%
  separate(Date, into = c("date", "time"), sep = "T") %>%
  unite(new, date, Time, sep = " ") %>%
  select(-time) %>%
  mutate(Date = parse_date_time(new, "%y-%m-%d %H:%M%p")) %>%
  select(-new) %>%
  select(id, programID, orchestra, season, eventType, Location, Venue, Date, everything())
# attenzione al warning
```

Posso rimuovere la colonna id?

```{r}
p1 <- prova %>% select(programID, id)
p1d <- distinct(p1)
length(unique(p1$programID)) # 14502 programID unici
length(unique(p1$id)) # 14507 id unici

# voglio trovare valori di programID che sono associati a più di un id
p1 %>% group_by(programID) %>% count(id) %>% count(programID, sort = TRUE) # qui ne vedo tre

p1 %>% group_by(id) %>% count(programID) %>% count(id, sort = TRUE)











p2 <- p1
anti_join(p1, p2, by=c("programID", "id"))
anti_join(p1, p2, by=c("id", "programID"))
prova %>% group_by("id") %>% group_by("programID") %>% count()
inner_join(p1,p2,"id")
distinctALL <- distinct(p1, programID, id)
distinctID <- prova %>% distinct(id)
distinctPID <- prova %>% distinct(programID)
anti_join(distinctALL,distinctPID)
str(prova)

all(!is.na(prova$id))
all(!is.na(prova$programID))
p2 <- rename(p2,programID2 = programID, id2 = id)
check <- tibble(p1,p2)

checkf <- function(a,b,c,d) {
  if (a == b) {
    if (b == d) {
      return (TRUE)
    } else {
      return (FALSE)
    }
  }
}
str(check)
sapply(check, checkf, a = programID, b = id, c = programID2, d = id2)
pmap(check,checkf)
```


```{r}

# 10 modelli che variano di più
mostvar <- models %>%
  group_by(composerName) %>%
  summarise(
    start = min(.fitted),
    end = max(.fitted),
    difference = end - start
  ) %>%
  arrange(-difference) %>%
  head(15)

# li plotto
models %>%
  semi_join(mostvar) %>%
  ggplot(mapping = aes(x = Year, y = .fitted, color = composerName)) +
  geom_line(alpha = 1/2)

# provo a plottare i valori reali con modello
unnest(yc, c(data,augment), names_sep = "_") %>%
semi_join(select(mostvar,composerName)) %>%
select(composerName,data_Year,data_n,augment_.fitted) %>%
ggplot(mapping = aes(x = data_Year, y = data_n, color = composerName)) +
  geom_line(mapping = aes(x = data_Year, y = data_n, color = composerName), alpha = 1/2) +
  geom_line(mapping = aes(x = data_Year, y = augment_.fitted), color = "blue") +
  facet_wrap(vars(composerName))

ggplot(mapping = aes(x = Year, y = .fitted, color = composerName)) +
  geom_line(alpha = 1/2, show.legend = FALSE)


models %>%
  filter(.fitted > 20) %>%
  ggplot(mapping = aes(x = Year, y = .fitted, color = composerName)) +
  geom_line(alpha = 1/2)

minoridiuno <- yc %>%
  mutate(tidied = map(model, tidy)) %>%
  select(composerName,tidied) %>%
  unnest(tidied) %>%
  select(term, estimate) %>%
  mutate(term = str_replace(term, "\\(Intercept\\)", "Intercept")) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  ungroup() %>%
  select(composerName, Intercept, Year) %>%
  filter(Year < 1)

programsT %>%
  distinct(eventType,Location,Venue,Date,Year,Time,workID,composerName) %>%
  filter(!is.na(composerName)) %>%
  anti_join(minoridiuno, by = join_by(composerName)) %>%
  group_by(Year,composerName) %>%
  count() %>%
ggplot(aes(Year, n, color = composerName)) +
  geom_line(alpha = 1/2)


```



Quali compositori sono stati rappresentati più a lungo?

```{r}
programsT %>%
  distinct(eventType,Location,Venue,Date,Year,Time,workID,composerName) %>%
  filter(!is.na(composerName)) %>%
  group_by(composerName) %>%
  summarise(
    first = min(Date),
    last = max(Date),
    timeSpan = (last - first) + 1
  ) %>%
  arrange(-timeSpan)
```

Densità di rappresentazioni.

```{r}
#da fare
```
```


Quanti compositori sono stati rappresentati.

```{r}
programsT %>%
  filter(!is.na(composerName)) %>%
  distinct(composerName) %>%
  count()
```

Quali sono stati i compositori più rappresentati? Conto quante rappresentazioni sono state fatte per ciascun compositore.
Considero i lavori, quindi i workID, se nello stesso concerto sono stati rappresentati più movimenti di uno stesso lavoro, il conteggio è comunque uno.

```{r}
programsT %>%
  distinct(eventType,Location,Venue,Date,Year,Time,workID,composerName) %>%
  filter(!is.na(composerName)) %>%
  group_by(composerName) %>%
  count(sort = TRUE)



```




```{r}
#trovo i compositori che compaiono in solo 5 anni o meno per poi toglierli
fiveorless <- programsT %>%
  distinct(eventType,Location,Venue,Date,Year,Time,workID,composerName) %>%
  filter(!is.na(composerName)) %>%
  group_by(composerName) %>%
  summarise(years = n_distinct(Year)) %>%
  filter(years <= 5)

yc <- programsT %>%
  distinct(eventType,Location,Venue,Date,Year,Time,workID,composerName) %>%
  filter(!is.na(composerName)) %>%
  anti_join(fiveorless) %>%
  group_by(composerName,Year) %>%
  count() %>%
  group_by(composerName) %>%
  nest()

yc_model <- function(df) {
  gam(n ~ Year, data = df)
}

yc <- yc %>%
  mutate(model = map(data, yc_model))

yc <- yc %>%
  mutate(augment = map(model, augment))

models <- unnest(yc, augment)

# 10 modelli che variano di più
mostvar <- models %>%
  group_by(composerName) %>%
  summarise(
    start = min(.fitted),
    end = max(.fitted),
    difference = end - start
  ) %>%
  arrange(-difference) %>%
  head(10)

# li plotto
models %>%
  semi_join(mostvar) %>%
  ggplot(mapping = aes(x = Year, y = .fitted, color = composerName)) +
  geom_line(alpha = 1/2)

# provo a plottare i valori reali con modello
unnest(yc, c(data,augment), names_sep = "_") %>%
semi_join(select(mostvar,composerName)) %>%
select(composerName,data_Year,data_n,augment_.fitted) %>%
ggplot(mapping = aes(x = data_Year, y = data_n, color = composerName)) +
  geom_line(mapping = aes(x = data_Year, y = data_n, color = composerName), alpha = 1/2) +
  geom_line(mapping = aes(x = data_Year, y = augment_.fitted), color = "blue") +
  facet_wrap(vars(composerName))

ggplot(mapping = aes(x = Year, y = .fitted, color = composerName)) +
  geom_line(alpha = 1/2, show.legend = FALSE)


models %>%
  filter(.fitted > 20) %>%
  ggplot(mapping = aes(x = Year, y = .fitted, color = composerName)) +
  geom_line(alpha = 1/2)

minoridiuno <- yc %>%
  mutate(tidied = map(model, tidy)) %>%
  select(composerName,tidied) %>%
  unnest(tidied) %>%
  select(term, estimate) %>%
  mutate(term = str_replace(term, "\\(Intercept\\)", "Intercept")) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  ungroup() %>%
  select(composerName, Intercept, Year) %>%
  filter(Year < 1)

programsT %>%
  distinct(eventType,Location,Venue,Date,Year,Time,workID,composerName) %>%
  filter(!is.na(composerName)) %>%
  anti_join(minoridiuno, by = join_by(composerName)) %>%
  group_by(Year,composerName) %>%
  count() %>%
ggplot(aes(Year, n, color = composerName)) +
  geom_line(alpha = 1/2)

```












```{r}
concerts <-
  programsT %>%
  select(eventType,Location,Venue,Date,Year,Month,Day,Time)

# ci sono 22407 concerti
concerts <- 
  concerts %>%
  unique()
```

che tipo di concerti ci sono

```{r}
ggplot(data = concerts) +
  geom_bar(mapping = aes(y = eventType))
```

```{r}
concerts %>%
  count(Location, sort = TRUE)
```

```{r}
ggplot(concerts) +
  geom_bar(mapping = aes(x = month(Date)))
```


```{r}
concerts %>%
  filter(Location == "Ann Arbor, MI") %>%
  arrange(Date)
```









```{r}
programsT %>%
  distinct(eventType,Location,Venue,Date,Year,Time,composerName) %>%
  filter(!is.na(composerName)) %>%
  group_by(Year,composerName) %>%
  count(sort = TRUE)
```

```{r}
programsT %>%
  filter(str_detect(composerName, "Mendelssohn"), Year == 1950) %>%
  arrange(Date) %>%
  select(programID,season,eventType,Location,Venue,Date,Time,workID,composerName,workTitle) %>%
  distinct(eventType,Location,Venue,Date,Time,workID,workTitle)
```






```{r}
library
ggplot(gapminder, aes(year, lifeExp)) +
    geom_line(aes(group = country), alpha = 1/3) +
    theme_classic()
```













Orchestre.

```{r}
orchestras <- programsT %>%
  distinct(orchestra,concertID, eventType, Location, Venue, Date, Year, Month, Day, Time)

orchestras %>%
  group_by(Year) %>%
  ggplot() +
  geom_bar(aes(y=orchestra))
```

Orchestre negli anni

```{r}
orchestras %>%
  group_by(Year) %>%
  count(orchestra) %>%
  ggplot(aes(x=Year,y=n,color=orchestra)) +
  geom_line(alpha = 1/3, show.legend = FALSE)
```




Venue negli anni.

```{r}
concerts %>%
  group_by(Year) %>%
  count(Venue) %>%
  ggplot(aes(x = Year, y = n, color = Venue)) +
    geom_line(alpha = 1/3, show.legend = FALSE)
```
Venue per anno.

```{r}
concerts %>%
  group_by(Year) %>%
  count(Venue) %>%
  mutate(total = sum(n)) %>%
  mutate(perc = n / total) %>%
  mutate(
    max = max(perc),
    min = min(perc)
  ) %>%
  filter(perc == max) %>%
  ggplot(aes(x = Year, y = n, color = Venue)) +
    geom_point(alpha = 1/3)
```

```{r}
concerts %>%
  group_by(Year) %>%
  count(Venue) %>%
  filter(Year == 1901)
```

```{r}
concerts %>%
  group_by(Year) %>%
  count(Venue) %>%
  filter(Year >= 1875 & Year <= 1925) %>%
  ggplot(aes(x = Year, y = n, color = Venue)) +
    geom_line(alpha = 1/3, show.legend = FALSE)
```

```{r}
concerts %>%
  group_by(Year) %>%
  count(Venue) %>%
  ggplot(aes(x = Year, y = n, color = Venue)) +
    geom_point(alpha = 1/3, show.legend = FALSE)
```

```{r}
concerts %>%
  group_by(Year) %>%
  group_by(Venue, .add = TRUE) %>%
  count()
```

Locations per anno. La più presente.

```{r}
concerts %>%
  group_by(Year) %>%
  count(Location) %>%
  mutate(total = sum(n)) %>%
  mutate(perc = n / total) %>%
  mutate(
    max = max(perc),
    min = min(perc)
  ) %>%
  filter(perc == max) %>%
  ggplot(aes(x = Year, y = n, color = Location)) +
    geom_point(alpha = 1/3)
```

Le seconde location per anno.

```{r}
concerts %>%
  group_by(Year) %>%
  count(Location) %>%
  mutate(total = sum(n)) %>%
  mutate(perc = n / total) %>%
  mutate (
    first = max(perc),
    second = nth(perc,2)
  ) %>%
  filter(perc == second) %>%
  ggplot(aes(x = Year, y = n, color = Location)) +
    geom_jitter(alpha = 1/3, show.legend = FALSE)
```

Quante Location per anno.

```{r}
concerts %>%
  distinct(Year,Location) %>%
  group_by(Year) %>%
  count()
```

Date.

```{r}
concerts %>%
  group_by(Month, Day) %>%
  summarise(n = n()) %>%
  arrange(-n)
```


```{r}
Lc
```


```{r}
pcp_models_simp %>%
  arrange(-seasonN)
```



```{r}
pcp_bin <- pcp %>%
  distinct(seasonN,composerName,n,totalSeason)

pcp_bin_n <- pcp_bin %>%
  group_by(composerName) %>%
  nest()

pcp_bin_n_models <- pcp_bin_n %>%
  mutate(models = map(data, ~ glm(cbind(n, totalSeason) ~ seasonN, ., family = "binomial")))

pcp_slopes <- pcp_bin_n_models %>%
  mutate(models = map(models, tidy)) %>% 
  unnest(cols = c(models)) %>%
  filter(term == "seasonN") %>%
  mutate(adjusted.p.value = p.adjust(p.value))

pcp_goodslopes <- pcp_slopes %>%
  filter(adjusted.p.value < 0.05)
```

Decrescenti 87.

```{r}
pcp_goodslopes %>%
  filter(estimate < 0)
```

Crescenti 41.

```{r}
pcp_goodslopes %>%
  filter(estimate > 0)
```

```{r}
pcp %>%
  semi_join(
    pcp_goodslopes %>%
      filter(estimate < 0) %>%
      head(30)
  ) %>%
  ggplot() +
  geom_point(aes(x = seasonN, y = n / totalSeason),alpha = 1/4) +
  facet_wrap(~composerName)
```

Crescenti

```{r}
pcp %>%
  semi_join(
    pcp_goodslopes %>%
      filter(estimate > 0) %>%
      head(30)
  ) %>%
  ggplot() +
  geom_point(aes(x = seasonN, y = n / totalSeason),alpha = 1/4) +
  facet_wrap(~composerName)
```

Meno buone.

```{r}
pcp_goodslopes <- pcp_slopes %>%
  filter(adjusted.p.value < 0.05)

pcp %>%
  semi_join(
    pcp_goodslopes <- pcp_slopes %>%
    filter(adjusted.p.value > 0.05) %>%
      head(30)
  ) %>%
  ggplot() +
  geom_point(aes(x = seasonN, y = n / totalSeason),alpha = 1/4) +
  facet_wrap(~composerName)

```

Outliers

```{r}
pcp_rest <- pcp %>%
  group_by(composerName) %>%
  mutate(
    lower_bound = quantile(perc, 0.5),
    upper_bound = quantile(perc, 0.95)
  ) %>%
  mutate(
    out = if_else((perc < lower_bound | perc > upper_bound), "OUT", "NO")
  ) %>%
  filter(out != "OUT")

pcp_rest <- pcp %>%
  filter(seasonN >= 87)

pep_rest <- pcp %>%
  mutate(logt = log(perc)) %>%
  ggplot() +
  geom_histogram(aes(logt))
  
  
pcp_rest <- pcp_rest %>%
  mutate(seasonN_2 = seasonN**2)

tenorless <- performances %>%
  group_by(composerName) %>%
  summarise(seasons = n_distinct(seasonN)) %>%
  filter(seasons <= 10)

pcp_rid_rest <- pcp_rest %>%
  anti_join(tenorless)

pcp_nested_rest <- pcp_rid_rest %>%
  group_by(composerName) %>%
  nest()

pcp_model_rest <- function(df) {
  lm(perc ~ seasonN + seasonN_2, data = df)
}

pcp_nested_rest <- pcp_nested_rest %>%
  mutate(model = map(data, pcp_model_rest))

pcp_nested_rest <- pcp_nested_rest %>%
  mutate(data = map2(data, model, add_residuals))

pcp_nested_rest <- pcp_nested_rest %>% 
  mutate(glance = map(model, broom::glance))

pcp_models_simp_rest <- pcp_nested_rest %>%
  mutate(model = map(model, tidy)) %>%
  unnest_longer(model) %>%
  unnest_wider(model) %>%
  select(composerName,term,estimate) %>%
  pivot_wider(names_from = term,values_from = estimate)

pcp_glance_rest <- unnest(pcp_nested_rest, glance, names_sep = "_")

pcp_resids_rest <- unnest(pcp_nested_rest, data)
```

```{r}
pcp_resids_rest %>%
  ggplot(aes(resid)) +
  geom_histogram()
```


Modelli in cui tutte e due le componenti sono positive. Non ci sono.
```{r}
up_up <- pcp_models_simp_rest %>%
  filter(seasonN > 0, seasonN_2 > 0) %>%
  select(composerName) %>%
  head(20)
```




```{r}
performances %>%
  group_by(seasonN, composerName) %>%
  mutate(totalCompSeason = n()) %>%
  group_by(season) %>%
  mutate(totalSeason = n()) %>%
  ungroup() %>%
  mutate(perc = totalCompSeason / totalSeason) %>%
  ungroup() %>%

  filter(composerName == "Weber, Carl Maria Von") %>%
  ggplot() +
  geom_point(aes(seasonN,perc))
```

```{r}
performances %>%
  group_by(seasonN, composerName) %>%
  mutate(totalCompSeason = n()) %>%
  group_by(season) %>%
  mutate(totalSeason = n()) %>%
  ungroup() %>%
  mutate(perc = totalCompSeason / totalSeason) %>%
  ungroup() %>%
  filter(composerName == "Weber, Carl Maria Von") %>%
  ggplot() +
  geom_bar(aes(y=conductorName))
```

```{r}
condperf <-
  performances %>%
  group_by(seasonN,conductorName) %>%
  mutate(totalCond = n()) %>%
  group_by(seasonN,conductorName,composerName) %>%
  mutate(composerCond = n()) %>%
  ungroup() %>%
  mutate(perc = composerCond / totalCond)

condperf %>%
  filter(composerName == "Weber, Carl Maria Von") %>%
  ggplot(aes(seasonN,composerCond,color=conductorName)) +
  geom_point(show.legend = FALSE)

  inner_join(webercond)

performances %>%
  group_by(seasonN, composerName) %>%
  mutate(totalCompSeason = n()) %>%
  group_by(season) %>%
  mutate(totalSeason = n()) %>%
  ungroup() %>%
  mutate(perc = totalCompSeason / totalSeason) %>%
  ungroup() %>%
  filter(composerName == "Weber, Carl Maria Von") %>%
  ggplot() +
  geom_point(aes(seasonN,perc,color=conductorName), show.legend = FALSE) +
  coord_cartesian(xlim=c(0,50))
```

```{r}
performances %>%
  group_by(seasonN, composerName) %>%
  mutate(totalCompSeason = n()) %>%
  group_by(season) %>%
  mutate(totalSeason = n()) %>%
  ungroup() %>%
  mutate(perc = totalCompSeason / totalSeason) %>%
  ungroup() %>%
  filter(composerName == "Weber, Carl Maria Von") %>%
  filter(seasonN < 50) %>%
  ggplot() +
  geom_bar(aes(y = conductorName))
```


```{r}
performances %>%
  group_by(seasonN, composerName) %>%
  mutate(totalCompSeason = n()) %>%
  group_by(season) %>%
  mutate(totalSeason = n()) %>%
  ungroup() %>%
  mutate(perc = totalCompSeason / totalSeason) %>%
  ungroup() %>%
  filter(composerName == "Weber, Carl Maria Von") %>%
  ggplot() +
  geom_point(aes(seasonN,perc,color=conductorName), show.legend = FALSE)
```



```{r}
performances %>%
  filter(seasonN <= 50) %>%
  filter(composerName == "Weber, Carl Maria Von") %>%
  ggplot() +
  geom_bar(aes(y=conductorName))

```

```{r}
webc <- performances %>%
  group_by(seasonN, composerName) %>%
  mutate(totalCompSeason = n()) %>%
  group_by(season) %>%
  mutate(totalSeason = n()) %>%
  ungroup() %>%
  mutate(perc = totalCompSeason / totalSeason) %>%
  ungroup() %>%
  filter(composerName == "Weber, Carl Maria Von") %>%
  filter(perc > 0.05) %>%
  distinct(conductorName)
```


Wagner.

```{r}
performances %>%
  group_by(seasonN, composerName) %>%
  mutate(totalCompSeason = n()) %>%
  group_by(season) %>%
  mutate(totalSeason = n()) %>%
  ungroup() %>%
  mutate(perc = totalCompSeason / totalSeason) %>%
  ungroup() %>%
  filter(composerName == "Wagner, Richard") %>%
  ggplot() +
  geom_vline(xintercept = 1923, linetype="dotted", color = "blue", size=1.5) +
  geom_vline(xintercept = 1930, linetype="dotted", color = "blue", size=1.5) +
  geom_vline(xintercept = 1945, linetype="dotted", color = "blue", size=1.5) +
  geom_point(aes(year,perc,color=conductorName), show.legend = FALSE)
```

Conduttori che hanno eseguito Wagner fra 1900 e 1930.

```{r}
performances %>%
  filter(year <= 1930 & year >= 1875) %>%
  filter(composerName == "Wagner, Richard") %>%
  ggplot() +
  geom_bar(aes(y=conductorName))
```

```{r}
performances %>%
  group_by(seasonN, composerName) %>%
  mutate(totalCompSeason = n()) %>%
  group_by(season) %>%
  mutate(totalSeason = n()) %>%
  ungroup() %>%
  mutate(perc = totalCompSeason / totalSeason) %>%
  ungroup() %>%
  filter(composerName == "Wagner, Richard") %>%
  ggplot() +
  geom_vline(xintercept = 1923, linetype="dotted", color = "blue", size=1.5) +
  geom_vline(xintercept = 1930, linetype="dotted", color = "blue", size=1.5) +
  geom_vline(xintercept = 1945, linetype="dotted", color = "blue", size=1.5) +
  geom_point(aes(year,perc,color=conductorName), show.legend = FALSE)
```

```{r}
wagc <- performances %>%
  group_by(seasonN, composerName) %>%
  mutate(totalCompSeason = n()) %>%
  group_by(season) %>%
  mutate(totalSeason = n()) %>%
  ungroup() %>%
  mutate(perc = totalCompSeason / totalSeason) %>%
  ungroup() %>%
  filter(composerName == "Wagner, Richard") %>%
  filter(perc > 0.15) %>%
  distinct(conductorName)

performances %>%
  group_by(seasonN) %>%
  mutate(seasonRep = n()) %>%
  group_by(seasonN,conductorName) %>%
  mutate(condRep = n()) %>%
  group_by(seasonN,conductorName,composerName) %>%
  mutate(condCompRep = n()) %>%
  ungroup() %>%
  mutate(perc = condCompRep / condRep) %>%
  inner_join(wagc) %>%
  filter(composerName == "Wagner, Richard") %>%
  ggplot() +
  geom_point(aes(seasonN,condRep,color=conductorName))
```


```{r}
performances %>%
  group_by(seasonN, composerName) %>%
  mutate(totalCompSeason = n()) %>%
  group_by(season) %>%
  mutate(totalSeason = n()) %>%
  ungroup() %>%
  mutate(perc = totalCompSeason / totalSeason) %>%
  ungroup() %>%
  filter(composerName == "Wagner, Richard") %>%
  anti_join(wagc) %>%
  ggplot() +
  geom_vline(xintercept = 1923, linetype="dotted", color = "blue", size=1.5) +
  geom_vline(xintercept = 1930, linetype="dotted", color = "blue", size=1.5) +
  geom_vline(xintercept = 1945, linetype="dotted", color = "blue", size=1.5) +
  geom_point(aes(year,perc,color=conductorName), show.legend = FALSE) +
  coord_cartesian(ylim = c(0.0,0.3))
```
















George Gershwin.

```{r}
cc %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  mutate(percent = totalC / totalM) %>%
  filter(composerName == "Gershwin,  George")
  
cc %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  mutate(percent = totalC / totalM) %>%
  filter(composerName == "Gershwin,  George") %>%
  ggplot() +
    geom_point(aes(x=reorder(month,monthid),y=percent))
```

Beethoven.

```{r}
cc %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  mutate(percent = totalC / totalM) %>%
  filter(composerName == "Beethoven,  Ludwig  van") %>%
  ggplot() +
    geom_point(aes(x=reorder(month,monthid),y=percent))

```

Inizio e fine delle subscription season.

```{r}
programsT %>%
  filter(eventType == "Subscription Season") %>%
  group_by(season) %>%
  mutate(
    start = min(Date),
    end = max(Date)
  ) %>%
  ggplot() +
  geom_point(aes(x=season,y=month(start), color="red")) +
  geom_point(aes(x=season,y=month(end), color="blue"))

```


Concentrandomi sulla subscription season.

```{r}

  
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  mutate(percent = totalC / totalM) %>%
  filter(percent > 0.01) %>%
  ggplot() +
    geom_tile(aes(x=reorder(month,monthid),y=composerName,fill=percent))

```

Beethoven.

```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  mutate(percent = totalC / totalM) %>%
  filter(composerName == "Beethoven,  Ludwig  van") %>%
  ggplot() +
    geom_point(aes(x=reorder(month,monthid),y=percent))
```

```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  filter(as.integer(month(Date)) == 8) %>%
  filter(composerName == "Beethoven,  Ludwig  van") %>%
  ggplot() +
  geom_point(aes(x=Date,y=))
```

Subscription Season con normalizzazione.

```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  ungroup() %>%
  group_by(month) %>%
  mutate(
    normalized = (totalC - min(totalC)) / (max(totalC) - min(totalC))
  ) %>%
  distinct(composerName,month,monthid,normalized) %>%
  filter(normalized > 0.2) %>%
  ggplot() +
    geom_tile(aes(x=reorder(month,monthid),y=composerName,fill=normalized))
```

Globale con normalizzazione.

```{r}
ccseason %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  ungroup() %>%
  group_by(month) %>%
  mutate(
    normalized = (totalC - min(totalC)) / (max(totalC) - min(totalC))
  ) %>%
  distinct(composerName,month,monthid,normalized) %>%
  filter(normalized > 0.2) %>%
  ggplot() +
    geom_tile(aes(x=reorder(month,monthid),y=composerName,fill=normalized))
```

Diverso da subscription con normalizzazione.

```{r}

ccseason %>%
  filter(eventType != "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  ungroup() %>%
  group_by(month) %>%
  mutate(
    normalized = (totalC - min(totalC)) / (max(totalC) - min(totalC))
  ) %>%
  distinct(composerName,month,monthid,normalized) %>%
  filter(normalized > 0.2) %>%
  ggplot() +
    geom_tile(aes(x=reorder(month,monthid),y=composerName,fill=normalized))

```


```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  filter(monthid == 5) %>%
  distinct(composerName,totalC) %>%
  arrange(-totalC)
```

```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  filter(monthid == 7)
```




```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(Year = year(Date)) %>%
group_by(Year,composerName) %>%
  count() %>%
ggplot(aes(Year, n, color = composerName)) +
  geom_line(alpha = 1/2, show.legend = FALSE)
```




