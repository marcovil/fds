---
title: "Performances"
output: html_document
date: "2023-03-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyr)
library(dplyr)
library(jsonlite)
library(purrr)
library(stringr)
library(lubridate)
library(modelr)
library(broom)
library(tibble)
library(ggplot2)
library(mgcv)
```

Apro il file JSON, per come è fatto devo accedere al primo elemento e posso quindi caricarlo in un tibble.
Sono 14.536 liste.

```{r}
complete <- read_json("complete.json")
programs <- complete[[1]]
programsT <- tibble(programs)
```

A questo punto ho la possibilità di accedere ai programmi, controllo che siano tutte liste di lunghezza 6.

```{r}
programsT %>%
  mutate(programs_L = sapply(programs,length)) %>%
  filter(programs_L != 6)
```

Posso quindi espandere i programmi.

```{r}
programsT <- programsT %>% unnest_wider(programs)
programsT %>% distinct(programID)
programsT %>% select(programID) %>% n_distinct() # ci sono 14531 programmi
```

Nella maggior parte dei casi a un programma è associato un concerto, ma non è sempre così. In totale ci sono 22525 concerti.

```{r}
programsT %>%
  mutate(concerts_L=sapply(concerts,length)) %>%
  count(concerts_L) %>%
  mutate(concertN = concerts_L * n) %>%
  mutate(concertsT = cumsum(concertN)) %>%
  arrange(-concertsT)
```

Espando i concerti, ottengo una riga per ogni concerto. Passo da 14.536 a 22.525 righe. Aggiungo anche una colonna concertID. Passo a 7 colonne.

```{r}
programsT <- programsT %>% unnest_longer(concerts)
nrow(programsT)
programsT <- rowid_to_column(programsT,var = "concertID")
programsT <- select(programsT,id,programID,orchestra,season,concertID,concerts,works)
```

Verifico che ogni concerto abbia 5 campi.

```{r}
programsT %>%
  mutate(concerts_L = sapply(concerts, length)) %>%
  filter(concerts_L != 5)
```

Posso espandere con unnest_wider. Allargo il tibble di 4 colonne, al posto di concerts ho eventType, Location, Venue, Date e Time.

```{r}
programsT <- programsT %>% unnest_wider(concerts)

```

Come si può vedere, un programma può contenere più concerti.

```{r}
programsT %>% group_by(programID) %>% count(sort = TRUE)
```

Per esempio il programma 10700 contiene 16 concerti. In questo caso vediamo anche che di alcuni concerti non è indicata l'ora.
Per questo motivo ho introdotto un concertID, se in seguito mi fossi limitato a identificare il concerto con eventType, Location, Venue, Date, Time, avrei perso alcuni concerti.

```{r}
programsT %>%
  filter(programID == 10700)
```

Ogni programma contiene un certo numero di lavori (works). In totale ci sono 125.224 works (si tratta di works che possono essere ripetuti in diversi programs).	

```{r}
programsT %>%
  mutate(works_L=sapply(works,length)) %>%
  count(works_L) %>%
  mutate(works_N = works_L * n) %>%
  mutate(works_T = cumsum(works_N)) %>%
  arrange(-works_T)
```

Ci sono dei program che hanno 0 works, che cosa sono? Si tratta di eventi che non prevedono musica o dei quali mancano informazioni.

```{r}
programsT %>%
  mutate(works_L=sapply(works,length)) %>%
  filter(works_L == 0)
```

Posso utilizzare unnest_longer, ogni lavoro associato a un programma darà origine a una riga. Devo usare l'opzione keep_empty TRUE per non perdere le righe con zero works.
Quindi il tibble passerà a 125.224 + 29 righe, ovvero 125.253.

```{r}
programsT <- programsT %>% unnest_longer(works, keep_empty = TRUE)
programsT %>% filter(programID == 13665)
```

Ora works contiene liste di lunghezze diverse, a seconda delle caratteristiche del work compreso. 

```{r}
programsT %>%
  mutate(works_L=sapply(works,length)) %>%
  count(works_L)
```

Le liste di lunghezza 3 sono quelle che contengono le intermissions.

```{r}
programsT %>%
  mutate(works_L = sapply(works,length)) %>%
  filter(works_L == 3) %>%
  select(works) %>%
  unnest_wider(works) %>%
  count(ID, interval, soloists)
```

Cerco di capire cosa contengono le altre liste (di lunghezza 4, 5 e 6). 

```{r}
programsT %>%
  mutate(works_L = sapply(works,length)) %>%
  filter(works_L == 4) %>%
  select(works) %>%
  unnest_wider(works)
```

```{r}
programsT %>%
  mutate(works_L = sapply(works,length)) %>%
  filter(works_L == 5) %>%
  select(works) %>%
  unnest_wider(works)
```

```{r}
programsT %>%
  mutate(works_L = sapply(works,length)) %>%
  filter(works_L == 6) %>%
  select(works) %>%
  unnest_wider(works)
```

Faccio unnest_wider di works. Passo da 11 colonne a 17 (al posto di works si aggiungono tutte le colonne comuni ai diversi works, ovvero ID, composerName, workTitle, movement, conductorName, soloists, interval)

```{r}
programsT <- programsT %>% unnest_wider(works)
```

Passo a prendere in considerazione workTitle.

```{r}
programsT %>%
  mutate(workTitle_L = sapply(workTitle,length)) %>%
  count(workTitle_L)
```

Come sono gli elementi di lunghezza 2.

```{r}
programsT %>%
  mutate(workTitle_L = sapply(workTitle, length)) %>%
  filter(workTitle_L == 2) %>%
  pull(workTitle) %>%
  head(3)
```

Mi salvo i program ID per ritrovarli dopo la modifica.

```{r}
wt2ids <- programsT %>%
  mutate(workTitle_L = sapply(workTitle, length)) %>%
  filter(workTitle_L == 2) %>%
  select(ID)
```

Applico funzione per sistemarli (sistemo anche NA al posto di NULL), faccio semi_join con gli id per verificare il risultato su quelli di lunghezza 2.

```{r}
mod_w <- function(x) {
  if (is.null(x)) return (NA)
  if (length(x) == 1) return (x[[1]])
  if (length(x) == 2) return (combine_w(x[[1]], x[[2]]))
}

combine_w <- function(x,y) {
  if (startsWith(x,",")) {
    return (paste(y,x))
  } else {
    return (paste(x,y))
  }
}

programsT %>%
  mutate(workTitle = sapply(workTitle, mod_w)) %>%
  semi_join(wt2ids) %>%
  select(workTitle)
```

Eseguo l'operazione e ri-assegno a programsT.

```{r}
programsT <- programsT %>%
  mutate(workTitle = sapply(workTitle, mod_w))
```

Verifico la lunghezza degli elementi contenuti in movement.

```{r}
programsT %>%
  mutate(movement_L = sapply(movement, length)) %>%
  count(movement_L)
```

Vedo come sono quelli di lunghezza 2.

```{r}
programsT %>%
  mutate(movement_L = sapply(movement, length)) %>%
  filter(movement_L == 2)
```

Mi limito a concatenarli, con la funzione mod_m. Inoltre sostituisco i NULL con NA.

```{r}
mod_m <- function(x) {
  if (is.null(x)) return (NA)
  if (length(x) == 1) return (x[[1]])
  if (length(x) == 2) return (paste(x[[1]], "_", x[[2]]))
}

programsT <- programsT %>% mutate(movement = sapply(movement, mod_m))
```

Controllo la lunghezza delle liste contenute in soloists. Ho 89.321 potenziali righe di informazioni su solisti + 85.122 righe nulle.

```{r}
programsT %>%
  mutate(soloists_L = sapply(soloists, length)) %>%
  count(soloists_L) %>%
  mutate(soloists_N = soloists_L * n) %>%
  mutate(soloists_T = cumsum(soloists_N)) %>%
  filter(soloists_L == 0 | soloists_L == max(soloists_L))
```

Provo unnest_longer di soloists con opzione keep_empty per tenere anche le righe che contengono liste NULL e vedo che sono di lunghezza 0 o 3.

```{r}
programsT %>%
  unnest_longer(soloists, keep_empty = TRUE) %>%
  mutate(soloists_L = sapply(soloists, length)) %>%
  count(soloists_L)
```

Ce ne sono cinque che sono di lunghezza 1, ma poi NULL.

```{r}
programsT %>%
  mutate(soloists_L = sapply(soloists, length)) %>%
  filter(soloists_L != 0) %>%
  unnest_longer(soloists, keep_empty = TRUE) %>%
  mutate(soloists_L2 = sapply(soloists, length)) %>%
  filter(soloists_L2 == 0)
```

Per esempio.

```{r}
programsT %>%
  filter(programID == 14489)
```


```{r}
programsT %>%
  filter(concertID == 1)
```

Faccio quindi unnest_longer, poi unnest_wider, il numero di colonne passa da 17 a 19 (soloistName, soloistInstrument e soloistRoles al posto di soloists).

```{r}
programsT <- programsT %>%
  unnest_longer(soloists, keep_empty = TRUE) %>%
  unnest_wider(soloists)
programsT
```

id rappresenta il GUID, che fa parte dell'indirizzo a cui è possibile vedere il programma online (archives.nyphil.org/index.php/artifact/GUID/fullview).
ci sono tre programID che sono associati a più GUID.
Tengo comunque la colonna id.

```{r}
ids <- programsT %>%
  distinct(id, programID) %>%
  group_by(programID) %>%
  count(sort = TRUE) %>%
  filter(n>1) %>%
  select(programID) %>%
  ungroup()

semi_join(programsT, ids) %>%
  distinct(id, programID) %>%
  select(id, programID)
```

Correggo come è scritta la data, aggiungo anche componenti anno, mese, giorno della data.

```{r}

#ci sono 5591 righe che contengono None invece dell'orario in formato AM o PM
programsT %>%
  mutate(trovato = str_detect(programsT$Time, "\\d{1,2}:\\d{1,2}[P,A]M")) %>%
  filter(trovato == FALSE)

# lascio Time com'è, sistemo la data, tenendo anche anno, mese, giorno
programsT <- programsT %>%
  mutate(Date = str_extract(Date, "[[:digit:]-]+")) %>%
  mutate(Date = ymd(Date)) %>%
  mutate(Year = year(Date)) %>%
  mutate(Month = month(Date)) %>%
  mutate(Day = day(Date)) %>%
  select(id, programID, orchestra, season, concertID, eventType, Location, Venue, Date, Year, Month, Day, Time, ID, composerName, workTitle, conductorName, soloistName, soloistInstrument, soloistRoles, movement, interval)

```

Divido ID in workID e movementID

```{r}
programsT <- programsT %>%
  separate(ID, into = c("workID", "movID"), sep = "\\*") %>%
  mutate(workID = as.integer(workID)) %>%
  mutate(movID = as.integer(movID))
```

Ci sono delle celle con valori multipli.

```{r}
programsT %>%
  mutate(co_conductor = str_detect(conductorName, ";")) %>%
  filter(co_conductor)
```

Correggo un errore (un conductorName scritto come "de Waart, Edo;  ;  ;  de Waart, Edo").

```{r}
programsT <- programsT %>%
  mutate(conductorName = if_else(str_detect(conductorName, ";\\s*;\\s*;"), "de Waart, Edo", conductorName))
```

Correggo errori nei nomi dei compositori.

```{r}
programsT <- programsT %>%
  mutate(composerName = str_replace_all(composerName, "\\s+", " "))
```

Modifico aggiungendo una colonna che indica la presenza di co-conduzione.

```{r}
programsT <- programsT %>%
  mutate(conductorName = str_remove(conductorName, "^; ")) %>%
  mutate(co_conductor = str_detect(conductorName, ";")) %>%
  separate_longer_delim(conductorName, "; ")
```

Costruisco tibble ridotti per le analisi successive.

```{r}
performances <- programsT %>%
  filter(is.na(interval)) %>%
  distinct(orchestra,eventType,season,concertID, Date, composerName, workTitle, conductorName, co_conductor) %>%
  mutate(year = year(Date)) %>%
  mutate(seasonN = dense_rank(season))

performances_works <- programsT %>%
  filter(is.na(interval)) %>%
  distinct(orchestra,eventType,season,concertID, Date, composerName, workTitle, workID, movID, conductorName, co_conductor) %>%
  mutate(year = year(Date)) %>%
  mutate(seasonN = dense_rank(season))

performances_works_complete <- performances_works %>%
  filter(is.na(movID))
```

Orchestre presenti nel database.

```{r}
ggplot(performances) +
  geom_bar(aes(y = orchestra))
```

Orchestre nel tempo.

```{r}
ggplot(performances) +
  geom_point(aes(seasonN, orchestra))
```

Andamento performance nelle stagioni.

```{r}
performances %>%
  group_by(seasonN) %>%
  count() %>%
  ggplot(mapping = aes(x = seasonN, y = n)) + 
  geom_point()
```



```{r}
performances %>%
  group_by(seasonN) %>%
  count() %>%
  ggplot(mapping = aes(x = seasonN, y = n)) + 
  geom_point() +
  geom_vline(aes(xintercept = 68, color = "red")) +
  coord_cartesian(xlim = c(0,80))
```

Che tipi di performance ci sono. Mi limito alle categorie che contengono più di 100 performance.

```{r}
performances %>%
  group_by(eventType) %>%
  count() %>%
  filter(n > 100) %>%
  ggplot(aes(x = n, y = eventType)) +
  geom_bar(stat = "identity")
```

```{r}
performances %>%
  group_by(eventType) %>%
  filter(orchestra == "New York Philharmonic") %>%
  count() %>%
  filter(n > 100) %>%
  ggplot(aes(x = n, y = eventType)) +
  geom_bar(stat = "identity")
```

```{r}
performances %>%
  filter(orchestra == "New York Philharmonic") %>%
  group_by(seasonN) %>%
  count() %>%
  ggplot(mapping = aes(x = seasonN, y = n)) + 
  geom_point() +
  geom_vline(aes(xintercept = 68, color = "red"))
```

```{r}
performances %>%
  filter(orchestra == "New York Philharmonic") %>%
  mutate(group = if_else(eventType == "Subscription Season", "SUB", "REST")) %>%
  group_by(seasonN,group) %>%
  count() %>%
  ggplot(aes(x = seasonN, y = n, colour = group)) +
  geom_point()
```

Quali sono gli eventType preponderanti dal 2000 in poi?

```{r}
performances %>%
  filter(orchestra == "New York Philharmonic") %>%
  filter(year >= 2000) %>%
  filter(eventType != "Subscription Season") %>%
  group_by(seasonN,eventType) %>%
  count() %>%
  ggplot(aes(x = seasonN, y = n, color = eventType)) +
  geom_line(alpha = 1/2, show.legend = FALSE)
```

Fra gli eventi che non fanno parte della stagione regolare, quelli presenti con maggior continuità sono tour e 
concerti non-subscription.

```{r}
performances %>%
  filter(orchestra == "New York Philharmonic") %>%
  filter(year >= 2000) %>%
  filter(eventType != "Subscription Season") %>%
  ggplot(aes(y=eventType)) +
  geom_bar()
```


```{r}
performances %>%
  filter(orchestra == "New York Philharmonic") %>%
  filter(year >= 2000) %>%
  filter(eventType != "Subscription Season") %>%
  group_by(seasonN,eventType) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(seasonEvents = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / seasonEvents) %>%
  group_by(seasonN) %>%
  filter(perc > 0.2) %>%
  ungroup() %>%
  ggplot() +
  geom_point(aes(seasonN, perc, color = eventType)) +
  geom_line(aes(seasonN, perc, color = eventType))
```

```{r}
performances %>%
  filter(orchestra == "New York Philharmonic") %>%
  filter(year >= 2000) %>%
  filter(eventType != "Subscription Season") %>%
  group_by(seasonN,eventType) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(seasonEvents = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / seasonEvents) %>%
  group_by(seasonN) %>%
  filter(eventType == "Bandwagon")
```

Da ora in poi mi limito a considerare New York Philharmonic.

```{r}
performances <- performances %>%
filter(orchestra == "New York Philharmonic")

performances_works <- performances_works %>%
  filter(orchestra == "New York Philharmonic")

performances_works_complete <- performances_works_complete %>%
  filter(orchestra == "New York Philharmonic")
```

Si possono trovare dei trend che ci permettano di dire qualcosa sulla popolarità di alcuni compositori nel corso del tempo?
Qui sotto un grafico con stagioni - numero di performance per compositore.

```{r}
pcp <- performances %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(totalSeason = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / totalSeason)

ggplot(pcp,aes(seasonN, n, color = composerName)) +
  geom_line(alpha = 1/4, show.legend = FALSE)
```

Questo con le percentuali. Per ogni compositore, la percentuale di performance del compositore rispetto al totale della stagione.

```{r}
ggplot(pcp,aes(seasonN, perc, color = composerName)) +
  geom_line(alpha = 1/4, show.legend = FALSE)
```

Costruisco un modello quadratico per tutti i compositori (dipendente percentuale, indipendenti stagione e stagione al quadrato). Tolgo i compositori che compaiono per meno di 11 stagioni.

```{r}
pcp <- pcp %>%
  mutate(seasonN_2 = seasonN**2)

tenorless <- performances %>%
  group_by(composerName) %>%
  summarise(seasons = n_distinct(seasonN)) %>%
  filter(seasons <= 10)

pcp_rid <- pcp %>%
  anti_join(tenorless)

pcp_nested <- pcp_rid %>%
  group_by(composerName) %>%
  nest()

pcp_model <- function(df) {
  lm(perc ~ seasonN + seasonN_2, data = df)
}

pcp_nested <- pcp_nested %>%
  mutate(model = map(data, pcp_model))

pcp_nested <- pcp_nested %>%
  mutate(data = map2(data, model, add_residuals))

pcp_nested <- pcp_nested %>% 
  mutate(glance = map(model, broom::glance))

pcp_models_simp <- pcp_nested %>%
  mutate(model = map(model, tidy)) %>%
  unnest_longer(model) %>%
  unnest_wider(model) %>%
  select(composerName,term,estimate) %>%
  pivot_wider(names_from = term,values_from = estimate)

pcp_glance <- unnest(pcp_nested, glance, names_sep = "_")

pcp_resids <- unnest(pcp_nested, data)
```

Prendo un subset di compositori per poter filtrare in un secondo momento. Almeno 80 stagioni, con densità 70 %.
Sono 25 compositori, responsabili per il 57 % delle performance.

```{r}
over80 <- performances %>%
  group_by(composerName) %>%
  mutate(
    seasons = n_distinct(seasonN),
    first = min(seasonN),
    last = max(seasonN),
    span = last - first + 1,
    density = seasons / span) %>%
  filter(seasons > 80 & density > 0.70) %>%
  distinct(composerName)

performances %>%
  mutate (totali = n()) %>%
  inner_join(over80) %>%
  mutate (over80 = n(), perc = over80 / totali) %>%
  distinct(perc)
```

Un altro subset, compositori rappresentati prima della stagione 67, per almeno 70 stagioni con densità 50 %. 50 % delle performance.

```{r}
before_season68 <- performances %>%
  group_by(composerName) %>%
  mutate(
    seasons = n_distinct(seasonN),
    first = min(seasonN),
    last = max(seasonN),
    span = last - first + 1,
    density = seasons / span) %>%
  filter(first < 68, seasons > 70 & density > 0.5) %>%
  distinct(composerName)

performances %>%
  mutate (totali = n()) %>%
  inner_join(before_season68) %>%
  mutate (before_season68 = n(), perc = before_season68 / totali) %>%
  distinct(perc)
```

Modelli in cui tutte e due le componenti sono positive. Non ci sono.

```{r}
up_up <- pcp_models_simp %>%
  filter(seasonN > 0, seasonN_2 > 0) %>%
  select(composerName) %>%
  head(20)
```

Modelli in cui tutte e due le componenti sono negative.

```{r}
down_down <- pcp_models_simp %>%
  filter(seasonN<0,seasonN_2<0) %>%
  select(composerName) %>%
  head(20)

pcp %>%
  semi_join(down_down) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```


Modelli in cui la componente quadratica è positiva e la componente lineare è negativa. Primi 20 per componente lineare.

```{r}
down_up <- pcp_models_simp %>%
  filter(seasonN<0,seasonN_2>0) %>%
  arrange(seasonN) %>%
  select(composerName) %>%
  head(20)

pcp %>%
  semi_join(down_up) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

Modelli in cui la componente quadratica è positiva e la componente lineare è negativa. Primi 20 per componente quadratica.

```{r}
down_up_2 <- pcp_models_simp %>%
  filter(seasonN<0,seasonN_2>0) %>%
  arrange(-seasonN_2) %>%
  select(composerName) %>%
  head(20)

pcp %>%
  semi_join(down_up_2) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```


Modelli in cui la componente quadratica è negativa e in cui la componente lineare è positiva. Filtrati per componente lineare più grande.

```{r}
up_down <- pcp_models_simp %>%
  filter(seasonN>0,seasonN_2<0) %>%
  arrange(-seasonN) %>%
  head(20) %>%
  select(composerName)

pcp %>%
  semi_join(up_down) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
``` 

Modelli in cui la componente quadratica è negativa e in cui la componente lineare positiva. Filtrati per componente quadratica più grande.

```{r}
up_down_2 <- pcp_models_simp %>%
  filter(seasonN>0,seasonN_2<0) %>%
  arrange(seasonN_2) %>%
  head(20) %>%
  select(composerName)

pcp %>%
  semi_join(up_down_2) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

Residui.

```{r}
pcp_resids %>%
  ggplot(aes(resid)) +
  geom_histogram()
```

Guardo a quelli con residui più alti di 0.1.

```{r}
highres <- pcp_resids %>%
  filter(resid >= 0.1) %>%
  distinct(composerName)

pcp %>%
  semi_join(highres) %>%
  ggplot() +
  geom_point(aes(x = seasonN, y = perc),alpha = 1/4) +
  facet_wrap(~composerName)
```

Modelli che fittano abbastanza bene.

```{r}
pcp_best <- pcp_glance %>%
  filter(glance_r.squared > 0.6) %>%
  select(composerName)

pcp %>%
  semi_join(pcp_best) %>%
  ggplot() +
  geom_point(aes(x = seasonN, y = perc),alpha = 1/4) +
  facet_wrap(~composerName)
  
```

Solo gli over 80.

```{r}
ggplot(
  pcp %>%
  inner_join(over80)
) +
  geom_point(aes(x = seasonN, y = perc),alpha = 1/4) +
  geom_vline(aes(xintercept = 68, color = "red")) +
  facet_wrap(~composerName)
```

Quelli che sono stati rappresentati prima della stagione 68.

```{r}
ggplot(
  pcp %>%
  inner_join(before_season68)
) +
  geom_point(aes(x = seasonN, y = perc),alpha = 1/4) +
  geom_vline(aes(xintercept = 68, color = "red")) +
  facet_wrap(~composerName)
```

Gini compositori.

```{r}
library(ineq)

gini_comp <- pcp %>%
  select(seasonN,n) %>%
  group_by(seasonN) %>%
  mutate(gini = Gini(n)) %>%
  distinct(seasonN,gini)

ggplot(gini_comp) +
    geom_vline(aes(xintercept = 68, color = "red")) +
    geom_line(aes(seasonN,gini))
```

Numero di compositori per stagione.

```{r}
performances %>%
  group_by(seasonN) %>%
  mutate(composers = n_distinct(composerName)) %>%
  ungroup() %>%
  ggplot() +
  geom_point(aes(seasonN,composers)) +
  geom_vline(aes(xintercept = 68, color = "red")) 
```

Gini compositori maggiore di 0.5.

```{r}
pcp %>%
  inner_join(
    gini_comp %>%
  filter(gini > 0.5)
  ) %>%
  ggplot(aes(seasonN,perc,color=composerName)) +
  geom_point(show.legend = FALSE)
```

Gini compositori maggiore di 0.5. Compositori che nella stagione hanno più dell'10% delle performance.

```{r}
pcp %>%
  inner_join(
    gini_comp %>%
  filter(gini > 0.5)
  ) %>%
  filter(perc > 0.1) %>%
  ggplot(aes(seasonN,perc,color=composerName)) +
  geom_point(show.legend = TRUE)
  
```


```{r}
comp_lorenz <- pcp %>%
  select(seasonN,n) %>%
  group_by(seasonN) %>%
  nest() %>%
  mutate(lc = map(data, function(x) Lc(x$n, plot = FALSE))) %>%
  mutate(q = 1-x.p, M = 1-x.L)

prova <- comp_lorenz %>%
  mutate(lct = map(lc, function(x) tibble(p = x$p,L = x$L))) %>%
  unnest(lct) %>%
  mutate(q = 1-p, M = 1-L)
    
  select(composerName,term,estimate) %>%
  pivot_wider(names_from = term,values_from = estimate) %>%
  

pcp %>%
  select(seasonN,composerName,n) %>%
  group_by(seasonN) %>%
  nest() %>%
  mutate(lorenz = map(data, ~Lc(.x$n, plot = FALSE))) %>%
  



tlcBuyer = tibble(p = lc$p, L = lc$L) %>% 
  mutate(q = 1-p, M = 1-L)
  
  
  ## Load and attach income (and metadata) set from Ilocos, Philippines
data(Ilocos)
attach(Ilocos)
## extract and rescale income for the provinces "Pangasinan" und "La Union"
income.p <- income[province=="Pangasinan"]/10000
income.u <- income[province=="La Union"]/10000
caso <- c(1,1,1,1,5)
Gini(c(1,1,1,1,1000))
## compute the Lorenz curves
Lc.p <- Lc(income.p)
Lc.u <- Lc(income.u)
Lc.caso <- Lc(caso)
## it can be seen the the inequality in La Union is higher than in
## Pangasinan because the respective Lorenz curve takes smaller values.
plot(Lc.p)
plot(Lc.caso)
lines(Lc.u, col=2)
## the picture becomes even clearer with generalized Lorenz curves
plot(Lc.p, general=TRUE)
lines(Lc.u, general=TRUE, col=2)
## inequality measures emphasize these results, e.g. Atkinson's measure
ineq(income.p, type="Atkinson")
ineq(income.u, type="Atkinson")
## or Theil's entropy measure
ineq(income.p, type="Theil", parameter=0)
ineq(income.u, type="Theil", parameter=0)
  
  
```




Come si sono evoluti i repertori dei conduttori?

```{r}
ccn <- performances %>%
  mutate(conductorName = if_else(is.na(conductorName),"NoName",conductorName)) %>%
  count(seasonN,conductorName,composerName) %>%
  group_by(conductorName,seasonN) %>%
  mutate(totalT = sum(n)) %>%
  rename(conductorT = n) %>%
  ungroup()

ccn_nested <- ccn %>%
  group_by(conductorName,composerName) %>%
  nest()

ccn_nested_models <- ccn_nested %>%
  mutate(models = map(data, ~ glm(cbind(conductorT, totalT) ~ seasonN, ., family = "binomial")))

slopes <- ccn_nested_models %>%
  mutate(models = map(models, tidy)) %>% 
  unnest(cols = c(models)) %>%
  filter(term == "seasonN") %>%
  mutate(adjusted.p.value = p.adjust(p.value))

top_slopes <- slopes %>%
  filter(adjusted.p.value < 0.05)
```

```{r}
conductors <- tibble(conductorName = c("Seidl, Anton", "Paur, Emil", "Damrosch, Walter", "Safonoff, Wassily", "Mahler, Gustav", "Stransky, Josef", "Mengelberg, Willem", "Toscanini, Arturo"))

composers <- tibble(composerName = c("Wagner, Richard", "Weber, Carl Maria Von"))

ccn %>%
  inner_join(
    top_slopes %>%
    inner_join(composers)
    ) %>%
  ggplot(aes(seasonN, conductorT / totalT, color = composerName)) +
  geom_line(show.legend = TRUE) +
  facet_wrap(~conductorName)

ccn %>%
  inner_join(
    slopes %>%
      inner_join(conductors) %>%
    inner_join(composers)
    ) %>%
  ggplot(aes(seasonN, conductorT / totalT, color = composerName)) +
  geom_line(show.legend = TRUE) +
  facet_wrap(~conductorName)

```



Prendo quelle che riguardano almeno 15 osservazioni.

```{r}
over10 <- top_slopes %>%
  unnest(data) %>%
  count() %>%
  filter(n >= 10)
```

Stagioni fra 50 e 80.

```{r}
seasons50_100 <- top_slopes %>%
  filter(conductorName != "NoName") %>%
  unnest(data) %>%
  filter(seasonN >= 50, seasonN <= 100) %>%
  arrange(estimate) %>%
  distinct(conductorName,composerName,estimate) %>%
  head(20)
```


```{r}
ccn %>%
  inner_join(over10) %>%
  ggplot(aes(seasonN, conductorT / totalT, color=composerName)) +
  geom_line(show.legend = FALSE) +
  facet_wrap(~conductorName)
```



```{r}
ccn %>%
  filter(conductorName == "Walter, Bruno") %>%
  inner_join(over15) %>%
  ggplot(aes(seasonN, conductorT / totalT, color=composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point() +
  facet_wrap(~conductorName)


```


```{r}
ccn %>%
  filter(conductorName == "Walter, Bruno") %>%
  ggplot(aes(seasonN, conductorT / totalT, color=composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point(show.legend = FALSE)
```





Gini conduttori.

```{r}
gini_cond <- performances %>%
  group_by(seasonN,conductorName) %>%
  mutate(conductorPerformances = n()) %>%
  group_by(seasonN) %>%
  mutate(seasonPerformances = n()) %>%
  ungroup() %>%
  distinct(seasonN,conductorName,conductorPerformances,seasonPerformances) %>%
  select(seasonN,conductorPerformances) %>%
  group_by(seasonN) %>%
  mutate(gini = Gini(conductorPerformances)) %>%
  distinct(seasonN,gini)
  
ggplot(gini_cond) +
    geom_line(aes(seasonN,gini))
```





















Come si sono evoluti i repertori dei conduttori?

```{r}
ccn <- performances %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  group_by(seasonN,conductorName,composerName) %>%
  mutate(compSeason = n()) %>%
  group_by(seasonN,conductorName) %>%
  mutate(condSeason = n()) %>%
  ungroup()

ccn_rid <- ccn %>%
  distinct(seasonN,conductorName,composerName,compSeason,condSeason)

ccn_rid_n <- ccn_rid %>%
  group_by(conductorName,composerName) %>%
  nest()

ccn_rid_n_models <- ccn_rid_n %>%
  mutate(models = map(data, ~ glm(cbind(compSeason, condSeason) ~ seasonN, ., family = "binomial")))

slopes <- ccn_rid_n_models %>%
  mutate(models = map(models, tidy)) %>% 
  unnest(cols = c(models)) %>%
  filter(term == "seasonN") %>%
  mutate(adjusted.p.value = p.adjust(p.value))

goodslopes <- slopes %>%
  filter(adjusted.p.value < 0.05)
```

Costruisco un elenco di direttori - compositori (tempo fra prima e ultima rappresentazione di quel compositore da parte di quel direttore).

```{r}
spans <- performances %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  group_by(conductorName,composerName) %>%
  mutate(
    min = min(seasonN),
    max = max(seasonN),
    span = max - min + 1
  ) %>%
  distinct(conductorName,composerName,span)
```

Seleziono alcuni modelli che hanno pendenza positiva. Per farlo mi concentro su quelli che hanno uno span di più di 10 anni.

```{r}
totalup <- slopes %>%
  filter(estimate > 0)

upslopes <- slopes %>%
  filter(adjusted.p.value < 0.05) %>%
  filter(estimate > 0) %>%
  inner_join(spans) %>%
  filter(span > 10) %>%
  arrange(-span) %>%
  head(20)

ccn_rid %>%
  inner_join(upslopes) %>%
  ggplot(aes(seasonN,compSeason / condSeason,color=composerName)) +
  geom_line() +
  facet_wrap(~conductorName)
```

Similmente con quelli che hanno pendenza negativa.

```{r}
totaldown <- slopes %>%
  filter(estimate < 0)

downslopes <- slopes %>%
  filter(adjusted.p.value < 0.05) %>%
  filter(estimate < 0) %>%
  inner_join(spans) %>%
  filter(span > 10) %>%
  arrange(-span) %>%
  head(20)

ccn_rid %>%
  inner_join(downslopes) %>%
  ggplot(aes(seasonN,compSeason / condSeason,color=composerName)) +
  geom_line() +
  facet_wrap(~conductorName)
```

Bernstein.

```{r}
ccn_rid %>%
  inner_join(upslopes) %>%
  filter(conductorName == "Bernstein, Leonard") %>%
  ggplot(aes(seasonN,compSeason / condSeason,color = composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point() +
  facet_wrap(~composerName)
```

Bernstein downslopes.

```{r}
ccn_rid %>%
  inner_join(downslopes) %>%
  filter(conductorName == "Bernstein, Leonard") %>%
  ggplot(aes(seasonN,compSeason / condSeason,color = composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point() +
  facet_wrap(~composerName)
```

Maazel.

```{r}
ccn_rid %>%
  inner_join(downslopes) %>%
  filter(conductorName == "Maazel, Lorin") %>%
  ggplot(aes(seasonN,compSeason / condSeason,color = composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point() +
  facet_wrap(~composerName)
```


```{r}
ccn_rid %>%
  filter(conductorName == "Mahler, Gustav") %>%
  filter(composerName == "Wagner, Richard") %>%
  ggplot(aes(seasonN,compSeason / condSeason,color = composerName)) +
  geom_line(show.legend = FALSE) +
  geom_point() +
  facet_wrap(~composerName)
```












































































































































```{r}
ccn_inv <- performances %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  group_by(seasonN,composerName,conductorName) %>%
  mutate(condSeason = n()) %>%
  group_by(seasonN,composerName) %>%
  mutate(compSeason = n()) %>%
  ungroup()

ccn_inv %>%
  filter(composerName == "Weber, Carl Maria Von")

ccn_inv_rid <- ccn_inv %>%
  distinct(seasonN,conductorName,composerName,compSeason,condSeason)

ccn_inv_rid_n <- ccn_inv_rid %>%
  group_by(composerName,conductorName) %>%
  nest()

ccn_inv_rid_n_models <- ccn_inv_rid_n %>%
  mutate(models = map(data, ~ glm(cbind(condSeason, compSeason) ~ seasonN, ., family = "binomial")))

slopes_inv <- ccn_inv_rid_n_models %>%
  mutate(models = map(models, tidy)) %>% 
  unnest(cols = c(models)) %>%
  filter(term == "seasonN") %>%
  mutate(adjusted.p.value = p.adjust(p.value))

ccn_inv_rid %>%
  inner_join(
    slopes_inv %>%
    arrange(estimate)
  ) %>%
  filter(composerName == "Wagner, Richard") %>%
  filter(seasonN >= 50 & seasonN <= 75) %>%
  ggplot(aes(seasonN,condSeason / compSeason)) +
  geom_point() +
  facet_wrap(~conductorName)



goodslopes_inv <- slopes_inv %>%
  filter(adjusted.p.value < 0.05)

goodslopes_inv2 <- goodslopes_inv %>%
unnest(data) %>%
  group_by(conductorName, composerName) %>%
  mutate(count = n()) %>%
  filter(count > 4) %>%
  ungroup() %>%
  distinct(conductorName,composerName,estimate)
```


```{r}
spans_inv <- performances %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  group_by(composerName,conductorName) %>%
  mutate(
    min = min(seasonN),
    max = max(seasonN),
    span = max - min + 1
  ) %>%
  distinct(composerName,conductorName,span)

```


```{r}
performances %>%
  filter(composerName == "Mahler, Gustav") %>%
  filter(seasonN == 126)

ccn_inv_rid %>%
  filter(composerName == "Mahler, Gustav") %>%
  filter(conductorName == "Steinberg, William")
```


```{r}
upslopes_inv <- goodslopes_inv2 %>%
  filter(estimate > 0) %>%
  arrange(-estimate) %>%
  head(20)

ccn_inv_rid %>%
  inner_join(upslopes_inv) %>%
  filter(composerName == "Wagner, Richard") %>%
  ggplot(aes(seasonN,condSeason / compSeason,color=conductorName)) +
  geom_point() +
  facet_wrap(~composerName)
```



```{r}
down_inv <- goodslopes_inv2 %>%
  filter(estimate < 0) %>%
  arrange(estimate) %>%
  head(20)

ccn_inv_rid %>%
  inner_join(down_inv) %>%
  #filter(composerName == "Beethoven, Ludwig van") %>%
  ggplot(aes(seasonN,condSeason / compSeason,color=conductorName)) +
  geom_point() +
  facet_wrap(~composerName)
```




Costruisco un elenco di direttori - compositori (tempo fra prima e ultima rappresentazione di quel compositore da parte di quel direttore).

```{r}
spans <- performances %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  group_by(conductorName,composerName) %>%
  mutate(
    min = min(seasonN),
    max = max(seasonN),
    span = max - min + 1
  ) %>%
  distinct(conductorName,composerName,span)
```


















```{r}
eightorless <- performances %>%
  filter(seasonN <= 80) %>%
  group_by(composerName) %>%
  summarise(seasons = n_distinct(seasonN)) %>%
  filter(seasons <= 10)

pcp_rid <- pcp %>%
  filter(seasonN <= 80) %>%
  anti_join(eightorless)

pcp_nested <- pcp_rid %>%
  group_by(composerName) %>%
  nest()

pcp_model <- function(df) {
  lm(perc ~ seasonN, data = df)
}

pcp_nested <- pcp_nested %>%
  mutate(model = map(data, pcp_model))

pcp_nested <- pcp_nested %>%
  mutate(data = map2(data, model, add_residuals))

pcp_nested <- pcp_nested %>% 
  mutate(glance = map(model, broom::glance))

pcp_models <- pcp_nested %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN" | term == "seasonN_2")

pcp_models <- unnest(pcp_models, glance, names_sep = "_")

pcp_resids <- unnest(pcp_models, data)
```






```{r}
pcp <- pcp %>%
  mutate(seasonN_2 = seasonN**2)

eightorless <- performances %>%
  group_by(composerName) %>%
  summarise(seasons = n_distinct(seasonN)) %>%
  filter(seasons <= 10)

pcp_rid <- pcp %>%
  anti_join(eightorless)

pcp_nested <- pcp_rid %>%
  group_by(composerName) %>%
  nest()

pcp_model <- function(df) {
  lm(perc ~ seasonN + seasonN_2, data = df)
}

pcp_nested <- pcp_nested %>%
  mutate(model = map(data, pcp_model))

pcp_nested <- pcp_nested %>%
  mutate(data = map2(data, model, add_residuals))

pcp_nested <- pcp_nested %>% 
  mutate(glance = map(model, broom::glance))

pcp_models <- pcp_nested %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN" | term == "seasonN_2")

pcp_nested %>%
  unnest_wider(model)

pcp_models_simp <- pcp_nested %>%
  mutate(model = map(model, tidy)) %>%
  unnest_longer(model) %>%
  unnest_wider(model) %>%
  select(composerName,term,estimate) %>%
  pivot_wider(names_from = term,values_from = estimate)

pcp_models <- unnest(pcp_models, glance, names_sep = "_")

pcp_resids <- unnest(pcp_models, data)
```

Modelli in cui tutte e due le componenti sono positive.

```{r}
up_up <- pcp_models_simp %>%
  filter(seasonN>0,seasonN_2>0) %>%
  select(composerName) %>%
  head(20)

pcp %>%
  semi_join(up_up) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

Modelli in cui tutti e due gli elementi sono negativi.

```{r}
down_down <- pcp_models_simp %>%
  filter(seasonN<0,seasonN_2<0) %>%
  select(composerName) %>%
  head(20)

pcp %>%
  semi_join(down_down) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

Modelli in cui la parabola è positiva e la componente lineare è negativa

```{r}
down_up <- pcp_models_simp %>%
  filter(seasonN<0,seasonN_2>0) %>%
  select(composerName) %>%
  head(20)

pcp %>%
  semi_join(down_up) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

Modelli in cui la parabola è negativa e in cui la componente lineare cresce. 

```{r}
up_down <- pcp_models_simp %>%
  filter(seasonN>0,seasonN_2<0) %>%
  select(composerName) %>%
  head(20)

pcp %>%
  semi_join(up_down) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```










































```{r}
down_slopes <- pcp_models %>%
  arrange(estimate) %>%
up_slopes <- pcp_models %>%
  filter(term == "seasonN") %>%
  arrange(-estimate) %>%
  head(20)

pcp %>%
  filter(seasonN <= 80) %>%
  semi_join(up_slopes) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)  head(20)

pcp %>%
  semi_join(down_slopes) %>%
  filter(seasonN < 70) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```


Costruisco un modello lineare anno - percentuale rappresentazioni per tutti i compositori. Tolgo i compositori che compaiono per meno di 11 stagioni.

```{r}
eightorless <- performances %>%
  filter(seasonN >= 80) %>%
  group_by(composerName) %>%
  summarise(seasons = n_distinct(seasonN)) %>%
  filter(seasons <= 10)

pcp_rid <- pcp %>%
  filter(seasonN >= 80) %>%
  anti_join(eightorless)

pcp_nested <- pcp_rid %>%
  group_by(composerName) %>%
  nest()

pcp_model <- function(df) {
  lm(perc ~ seasonN, data = df)
}

pcp_nested <- pcp_nested %>%
  mutate(model = map(data, pcp_model))

pcp_nested <- pcp_nested %>%
  mutate(data = map2(data, model, add_residuals))

pcp_nested <- pcp_nested %>% 
  mutate(glance = map(model, broom::glance))

pcp_models <- pcp_nested %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN" | term == "seasonN_2")

pcp_models <- unnest(pcp_models, glance, names_sep = "_")

pcp_resids <- unnest(pcp_models, data)
```

```{r}
up_slopes <- pcp_models %>%
  filter(term == "seasonN") %>%
  arrange(-estimate) %>%
  head(20)

pcp %>%
  filter(seasonN >= 80) %>%
  semi_join(up_slopes) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)

good <- pcp_models %>%
  filter(glance_r.squared > 0.70) %>%
  head(20) %>%
  select(composerName)

pcp %>%
  filter(seasonN >= 80) %>%
  semi_join(good) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)

bad <- pcp_models %>%
  filter(glance_r.squared < 0.30) %>%
  head(20) %>%
  select(composerName)

pcp %>%
  filter(seasonN <= 80) %>%
  semi_join(bad) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)

down_slopes <- pcp_models %>%
  filter(term == "seasonN") %>%
  arrange(estimate) %>%
  head(20)

pcp %>%
  filter(seasonN >= 80) %>%
  semi_join(down_slopes) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

























Costruisco un modello lineare anno - percentuale rappresentazioni per tutti i compositori. Tolgo i compositori che compaiono per meno di 11 stagioni.

```{r}
tenorless <- performances %>%
  group_by(composerName) %>%
  summarise(seasons = n_distinct(seasonN)) %>%
  filter(seasons <= 10)

pcprid <- pcp %>%
  filter(seasonN > 70) %>%
  anti_join(tenorless)

pcpn <- pcprid %>%
  group_by(composerName) %>%
  nest()

pcp_model <- function(df) {
  lm(perc ~ seasonN, data = df)
}

pcpn <- pcpn %>%
  mutate(model = map(data, pcp_model))

pcpn <- pcpn %>%
  mutate(data = map2(data, model, add_residuals))

pcpn <- pcpn %>% 
  mutate(glance = map(model, broom::glance))

pcp_models <- pcpn %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN")

pcp_models <- unnest(pcp_models, glance, names_sep = "_")

pcp_resids <- unnest(pcp_models, data)
```

```{r}
up_slopes <- pcp_models %>%
  arrange(-estimate) %>%
  head(20)

pcp %>%
  semi_join(up_slopes) %>%
  filter(seasonN > 70) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

```{r}
down_slopes <- pcp_models %>%
  arrange(estimate) %>%
  head(20)

pcp %>%
  semi_join(down_slopes) %>%
  filter(seasonN > 70) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```


```{r}

```












Costruisco un modello lineare anno - numero rappresentazioni per tutti i compositori. Tolgo i compositori che compaiono per meno di 11 stagioni.

```{r}
tenorless <- performances %>%
  group_by(composerName) %>%
  summarise(seasons = n_distinct(seasonN)) %>%
  filter(seasons <= 10)

pcnrid <- pcp %>%
  anti_join(tenorless)

pcnn <- pcnrid %>%
  group_by(composerName) %>%
  nest()

pcn_model <- function(df) {
  lm(n ~ seasonN, data = df)
}

pcnn <- pcnn %>%
  mutate(model = map(data, pcn_model))

pcnn <- pcnn %>%
  mutate(data = map2(data, model, add_residuals))

pcnn <- pcnn %>% 
  mutate(glance = map(model, broom::glance))

pcn_models <- pcnn %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN")

pcn_models <- unnest(pcn_models, glance, names_sep = "_")

pcn_resids <- unnest(pcn_models, data)
```

```{r}
up_slopes <- pcn_models %>%
  arrange(-estimate) %>%
  head(20)

pcp %>%
  semi_join(up_slopes) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

```{r}
down_slopes <- pcn_models %>%
  arrange(estimate) %>%
  head(20)

pcp %>%
  semi_join(down_slopes) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```


```{r}
pcn_resids %>%
  ggplot() +
  geom_histogram(aes(resid,binwidth = 5)) +
  coord_cartesian(ylim = c(0,100))
```

```{r}
highres <- pcn_resids %>%
  filter(resid > 40) %>%
  select(composerName)
```

```{r}

  
  performances %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(totalSeason = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / totalSeason) %>%
  anti_join(highres) %>%
  ggplot(aes(seasonN, n, color = composerName)) +
  geom_line(alpha = 1/2, show.legend = FALSE)

pcn_resids %>%
  ggplot(aes(seasonN, resid, color = composerName)) +
  geom_line(alpha = 1/2, show.legend = FALSE)


  
  
```

```{r}
pcp

pcpn <- pcp %>%
  group_by(composerName) %>%
  nest()

pcpn_models <- pcpn %>%
  mutate(models = map(data, ~ glm(cbind(n, totalSeason) ~ seasonN, ., family = "binomial")))

pcpn <- pcpn %>%
  mutate(model = map(data, pcp_model))

pcpn <- pcpn_models %>%
  mutate(data = map2(data, models, add_residuals))

pcpn_models <- pcpn_models %>% 
  mutate(glance = map(model, broom::glance))

pcp_models <- pcpn %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN")

pcp_models <- unnest(pcp_models, glance, names_sep = "_")

pcp_resids <- unnest(pcp_models, data)
```


```{r}
composers = n_distinct(pwp$composerName)

pwprid <- pwp %>%
  group_by(composerName) %>%
  mutate(
    min = min(seasonN),
    max = max(seasonN),
    span = max - min + 1,
    seasons = n_distinct(seasonN),
    density = seasons / span
  ) %>%
  filter(density < 1 & density > 0.1)

composers2 = n_distinct(pwprid$composerName)
```



```{r}
pwp <- performances_works %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(totalSeason = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / totalSeason) %>%
  (ungroup)
```

```{r}
pw <- pwprid %>%
  group_by(composerName) %>%
  nest()

pw_model <- function(df) {
  lm(perc ~ seasonN, data = df)
}

pw <- pw %>%
  mutate(model = map(data, pw_model))

pw <- pw %>% 
  mutate(data = map2(data, model, add_residuals))

pw <- pw %>% 
  mutate(glance = map(model, broom::glance))

pw_models <- pw %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN")

pw_models <- unnest(pw_models, glance, names_sep = "_")

pw_resids <- unnest(pw_models, data)
```


```{r}
pw_models %>%
  filter(glance_r.squared != 1) %>%
  arrange(-glance_r.squared)
```

```{r}
rsq20 <- pw_models %>%
  filter(glance_r.squared != 1) %>%
  arrange(-estimate) %>%
  select(composerName) %>%
  head(20)
```

```{r}
performances %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(totalSeason = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / totalSeason) %>%
ggplot(aes(seasonN, perc, color = composerName)) +
  geom_line(alpha = 1/2, show.legend = FALSE)

pwp %>%
  inner_join(rsq20) %>%
  ggplot(aes(seasonN,perc,color=composerName)) +
  geom_line(show.legend = FALSE) +
  facet_wrap(~composerName)
```




Come si è evoluto nelle stagioni il numero di performance per compositore.

```{r}
performances %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  ggplot() +
  geom_line(alpha = 1/2, aes(seasonN, n, color = composerName), show.legend = FALSE)
```

Costruisco un modello lineare anno-rappresentazioni per tutti i compositori. Tolgo i compositori che compaiono per meno di 8 stagioni.

```{r}
eightorless <- performances %>%
  group_by(composerName) %>%
  summarise(seasons = n_distinct(seasonN)) %>%
  filter(seasons <= 8)

pwc <- performances %>%
  anti_join(eightorless) %>%
  group_by(composerName,seasonN) %>%
  count()

pw <- pwc %>%
  group_by(composerName) %>%
  nest()

pw_model <- function(df) {
  lm(n ~ seasonN, data = df)
}

pw <- pw %>%
  mutate(model = map(data, pw_model))

pw <- pw %>% 
  mutate(data = map2(data, model, add_residuals))

pw <- pw %>% 
  mutate(glance = map(model, broom::glance))

pw_models <- pw %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN")

pw_models <- unnest(pw_models, glance, names_sep = "_")

pw_resids <- unnest(pw_models, data)
```

Guardo ai residui. Ci sono un po' di residui molto alti, sopra a 50.

```{r}
pw_resids %>%
  ggplot(aes(resid)) +
  geom_histogram(binwidth = 5) +
  coord_cartesian(ylim = c(0,100))
```

Mi concentro su questi.

```{r}
highres <- pw_resids %>%
  filter(resid > 40) %>%
  select(composerName)
highres
```

```{r}
pwc %>%
  inner_join(highres, by = join_by(composerName)) %>%
  ggplot(aes(seasonN,n)) +
    geom_point(alpha = 1/4) +
    facet_wrap(~composerName)
```

```{r}
best <- pw_models %>%
  arrange(-glance_r.squared) %>%
  head(10)

worst <- pw_models %>%
  arrange(glance_r.squared) %>%
  head(10)
```

```{r}
up_slopes <- pw_models %>%
  arrange(-estimate) %>%
  head(10)

pwc %>%
  semi_join(up_slopes) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

```{r}  
down_slopes <- pw_models %>%
  arrange(estimate) %>%
  head(10)

pwc %>%
  semi_join(down_slopes) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

Filtro le stagioni in cui c'è stato il massimo di performance.

```{r}
performances_works %>%
  inner_join(highres) %>%
  group_by(composerName, seasonN, season) %>%
  count() %>%
  group_by(composerName) %>%
  mutate(max = max(n)) %>%
  filter (n == max) %>%
  ungroup()
```

Da ora in poi mi limito a considerare la Subscription Season della New York Philharmonic.

```{r}
performances_works_complete <- performances_works_complete %>%
  filter(orchestra == "New York Philharmonic") %>%
  filter(eventType == "Subscription Season")
```

Come si è evoluto nelle stagioni il numero di performance per compositore.

```{r}
performances_works_complete %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  ggplot() +
  geom_line(alpha = 1/2, aes(seasonN, n, color = composerName), show.legend = FALSE)
```

Costruisco un modello lineare anno-rappresentazioni per tutti i compositori. Tolgo i compositori che compaiono per meno di 8 stagioni.

```{r}
eightorless_c <- performances_works_complete %>%
  group_by(composerName) %>%
  summarise(seasons = n_distinct(seasonN)) %>%
  filter(seasons <= 8)

pwc_c <- performances_works_complete %>%
  anti_join(eightorless_c) %>%
  group_by(composerName,seasonN) %>%
  count()

pwc_c <- performances_works_complete %>%
  anti_join(eightorless_c) %>%
  group_by(composerName,seasonN) %>%
  count()

pw_c <- pwc_c %>%
  group_by(composerName) %>%
  nest()

pw_c_model <- function(df) {
  lm(n ~ seasonN, data = df)
}

pw_c <- pw_c %>%
  mutate(model = map(data, pw_c_model))

pw_c <- pw_c %>% 
  mutate(data = map2(data, model, add_residuals))

pw_c <- pw_c %>% 
  mutate(glance = map(model, broom::glance))

pw_c_models <- pw_c %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN")

pw_c_models <- unnest(pw_c_models, glance, names_sep = "_")

pw_c_resids <- unnest(pw_c_models, data)
```

Guardo ai residui. Ci sono un po' di residui molto alti, sopra a 50.

```{r}
pw_c_resids %>%
  ggplot(aes(resid)) +
  geom_histogram(binwidth = 5) +
  coord_cartesian(ylim = c(0,100))
```

Mi concentro su questi.

```{r}
highres_c <- pw_c_resids %>%
  filter(resid > 25) %>%
  select(composerName)
highres_c
```

```{r}
pwc_c %>%
  inner_join(highres_c, by = join_by(composerName)) %>%
  ggplot(aes(seasonN,n)) +
    geom_point(alpha = 1/4) +
    facet_wrap(~composerName)
```

```{r}
best_c <- pw_c_models %>%
  arrange(-glance_r.squared) %>%
  head(10)

worst_c <- pw_c_models %>%
  arrange(glance_r.squared) %>%
  head(10)
```

```{r}
up_slopes_c <- pw_c_models %>%
  arrange(-estimate) %>%
  head(10)

pwc_c %>%
  semi_join(up_slopes_c) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

```{r}  
down_slopes_c <- pw_c_models %>%
  arrange(estimate) %>%
  head(10)

pwc %>%
  semi_join(down_slopes_c) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```


```{r}
performances_works_complete %>%
  group_by(seasonN) %>%
  count() %>%
  ggplot() +
  geom_point(aes(seasonN,n))
```

```{r}
performances_works_complete %>%
  group_by(seasonN) %>%
  count() %>%
  filter(n > 100)
```


Costruisco un modello lineare anno-rappresentazioni per tutti i compositori. Tolgo i compositori che compaiono per meno di 8 stagioni.

```{r}
eightorless_c <- performances_works_complete %>%
  filter(seasonN > 68) %>%
  group_by(composerName) %>%
  summarise(seasons = n_distinct(seasonN)) %>%
  filter(seasons <= 8)

prwc_c <- performances_works_complete %>%
  filter(seasonN > 68) %>%
  anti_join(eightorless_c) %>%
  group_by(composerName,seasonN) %>%
  count()

prw_c <- prwc_c %>%
  group_by(composerName) %>%
  nest()

prw_c_model <- function(df) {
  lm(n ~ seasonN, data = df)
}

prw_c <- prw_c %>%
  mutate(model = map(data, prw_c_model))

prw_c <- prw_c %>% 
  mutate(data = map2(data, model, add_residuals))

prw_c <- prw_c %>% 
  mutate(glance = map(model, broom::glance))

prw_c_models <- prw_c %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN")

prw_c_models <- unnest(prw_c_models, glance, names_sep = "_")

prw_c_resids <- unnest(prw_c_models, data)
```

Guardo ai residui. Ci sono un po' di residui molto alti, sopra a 50.

```{r}
prw_c_resids %>%
  ggplot(aes(resid)) +
  geom_histogram(binwidth = 5) +
  coord_cartesian(ylim = c(0,100))
```

Mi concentro su questi.

```{r}
highres_c <- prw_c_resids %>%
  filter(resid > 25) %>%
  select(composerName)
highres_c
```

```{r}
prwc_c %>%
  inner_join(highres_c, by = join_by(composerName)) %>%
  ggplot(aes(seasonN,n)) +
    geom_point(alpha = 1/4) +
    facet_wrap(~composerName)
```

```{r}
highres_c <- prw_c_resids %>%
  filter(resid > 20) %>%
  select(composerName)
highres_c
```

```{r}
prwc_c %>%
  anti_join(highres_c, by = join_by(composerName)) %>%
  ggplot(aes(seasonN,n,color=composerName)) +
    geom_point(alpha = 1/4,show.legend = FALSE)
```

```{r}
best_c <- prw_c_models %>%
  arrange(-glance_r.squared) %>%
  head(10)

worst_c <- prw_c_models %>%
  arrange(glance_r.squared) %>%
  head(10)
```

```{r}
up_slopes_c <- prw_c_models %>%
  arrange(-estimate) %>%
  head(10)

prwc_c %>%
  semi_join(up_slopes_c) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```

```{r}  
down_slopes_c <- prw_c_models %>%
  arrange(estimate) %>%
  head(10)

prwc_c %>%
  semi_join(down_slopes_c) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_point(alpha = 1/4) +
  facet_wrap(~composerName)
```


```{r}
performances_works_complete %>%
  filter(composerName == "Wagner,  Richard")
  
  group_by(seasonN) %>%
  count() %>%
  ggplot() +
  geom_point(aes(seasonN,n))
```

```{r}

```





Filtro le stagioni in cui c'è stato il massimo di performance.

```{r}
performances_works %>%
  inner_join(highres) %>%
  group_by(composerName, seasonN, season) %>%
  count() %>%
  group_by(composerName) %>%
  mutate(max = max(n)) %>%
  filter (n == max) %>%
  ungroup()























Costruisco un modello lineare anno-rappresentazioni per tutti i compositori. Tolgo i compositori che compaiono per meno di 11 stagioni.

```{r}
complete <- complete %>%
  filter(orchestra == "New York Philharmonic") %>%
  filter(eventType == "Subscription Season")

tenorless <- complete %>%
  group_by(composerName) %>%
  summarise(seasons = n_distinct(seasonN)) %>%
  filter(seasons <= 10)

sc <- complete %>%
  anti_join(tenorless) %>%
  group_by(composerName,seasonN) %>%
  count() %>%
  group_by(composerName) %>%
  nest()

sc_model <- function(df) {
  lm(n ~ seasonN, data = df)
}

sc <- sc %>%
  mutate(model = map(data, sc_model))

sc <- sc %>% 
  mutate(data = map2(data, model, add_residuals))

sc <- sc %>% 
  mutate(glance = map(model, broom::glance))

models <- sc %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model))

slopes <- models %>%
  filter(term == "seasonN")

slopes %>%
  ggplot() +
  geom_histogram(aes(x=estimate))
```

pendenza crescente

```{r}
upslopes <- slopes %>%
  filter(estimate > 0) %>%
  arrange(-estimate) %>%
  head(20)

models %>%
  unnest(data) %>%
  semi_join(upslopes) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_line() +
  facet_wrap(~composerName)
```

decrescente

```{r}
downslopes <- slopes %>%
  filter(estimate < 0) %>%
  arrange(estimate) %>%
  head(20)

models %>%
  unnest(data) %>%
  semi_join(downslopes) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_line() +
  facet_wrap(~composerName)
```



```{r}
programsT %>%
  filter(programID == 7987)
```

```{r}
programsT %>%
  filter(workID == 52446) %>%
  filter(!is.na(movID))
```







Pendenza crescente.

```{r}
upslopes <- slopes %>%
  filter(estimate > 0) %>%
  arrange(-estimate) %>%
  head(20)

models %>%
  unnest(data) %>%
  semi_join(upslopes) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_line() +
  facet_wrap(~composerName)
```

```{r}
downslopes <- slopes %>%
  filter(estimate < 0) %>%
  arrange(estimate) %>%
  head(20)

models %>%
  unnest(data) %>%
  semi_join(downslopes) %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_line() +
  facet_wrap(~composerName)
```

Fit dei modelli.

```{r}
sc <- sc %>% 
  mutate(glance = map(model, broom::glance))
  
glance = unnest(sc, glance)

best_fit <- glance %>%
  arrange(-r.squared) %>%
  head(20)

models %>%
  unnest(data) %>%
  semi_join(best_fit, by="composerName") %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_line() +
  geom_smooth() +
  facet_wrap(~composerName)
```

Quelli che fittano peggio.
  
```{r}
worst_fit <- glance %>%
  arrange(r.squared) %>%
  head(20)

models %>%
  unnest(data) %>%
  semi_join(worst_fit, by="composerName") %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_line() +
  geom_smooth() +
  facet_wrap(~composerName)
```

Guardo i residui. Prima verso l'alto.

```{r}
resids <- unnest(sc, data)

up_resids <- resids %>%
  arrange(-resid) %>%
  head(20)

down_resids <- resids %>%
  arrange(resid) %>%
  head(20)

models %>%
  unnest(data) %>%
  semi_join(up_resids, by="composerName") %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_line() +
  geom_smooth() +
  facet_wrap(~composerName)

```

Poi verso il basso.

```{r}
models %>%
  unnest(data) %>%
  semi_join(down_resids, by="composerName") %>%
  ggplot(aes(x = seasonN, y = n)) +
  geom_line() +
  geom_smooth() +
  facet_wrap(~composerName)
```

Stessa cosa ma lavorando con le percentuali.

```{r}
ccseason %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(totalSeason = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / totalSeason) %>%
ggplot(aes(seasonN, perc, color = composerName)) +
  geom_line(alpha = 1/2, show.legend = FALSE)
```

Costruisco un modello lineare anno-rappresentazioni per tutti i compositori. Tolgo i compositori che compaiono per meno di 11 anni.

```{r}
scp <- ccseason %>%
  anti_join(tenorless) %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(totalSeason = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / totalSeason) %>%
  group_by(composerName) %>%
  nest()

scp_model <- function(df) {
  lm(perc ~ seasonN, data = df)
}

scp <- scp %>%
  mutate(model = map(data, scp_model))

scp <- scp %>% 
  mutate(data = map2(data, model, add_residuals))

modelsp <- scp %>%
  mutate(model = map(model, tidy)) %>%
  unnest(cols = c(model))

slopesp <- modelsp %>%
  filter(term == "seasonN")

slopesp %>%
  ggplot() +
  geom_histogram(aes(x=estimate))
```

```{r}
upslopesp <- slopesp %>%
  filter(estimate > 0) %>%
  arrange(-estimate) %>%
  head(20)

modelsp %>%
  unnest(data) %>%
  semi_join(upslopesp) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/3) +
  facet_wrap(~composerName)
```

```{r}
downslopesp <- slopesp %>%
  filter(estimate < 0) %>%
  arrange(estimate) %>%
  head(20)

modelsp %>%
  unnest(data) %>%
  semi_join(downslopesp) %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_point(alpha = 1/3) +
  facet_wrap(~composerName)
```

Fit dei modelli.

```{r}
ycp <- ycp %>% 
  mutate(glance = map(model, broom::glance))
  
glancep = unnest(ycp, glance)

worst_fitp <- glance %>%
  arrange(r.squared) %>%
  head(20)

modelsp %>%
  unnest(data) %>%
  semi_join(worst_fitp, by="composerName") %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_line() +
  facet_wrap(~composerName)
```

```{r}
best_fitp <- glance %>%
  arrange(-r.squared) %>%
  head(20)

modelsp %>%
  unnest(data) %>%
  semi_join(best_fitp, by="composerName") %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_line() +
  facet_wrap(~composerName)
```

Residui.

```{r}
residsp <- unnest(ycp, data)

up_residsp <- residsp %>%
  arrange(-resid) %>%
  head(20)

modelsp %>%
  unnest(data) %>%
  semi_join(top_residsp, by="composerName") %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_line() +
  geom_smooth() +
  facet_wrap(~composerName)
```

```{r}
down_residsp <- residsp %>%
  arrange(resid) %>%
  head(20)

modelsp %>%
  unnest(data) %>%
  semi_join(bot_residsp, by="composerName") %>%
  ggplot(aes(x = seasonN, y = perc)) +
  geom_line() +
  geom_smooth() +
  facet_wrap(~composerName)
```

SD nella percentuale per season.

```{r}
ccseason %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(totalSeason = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / totalSeason) %>%
  group_by(seasonN) %>%
  mutate(
    sd = sd(perc)
  ) %>%
  ggplot() +
  geom_point(aes(seasonN,sd))
```

SD nella percentuale per compositori.

```{r}
ccseason %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(totalSeason = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / totalSeason) %>%
  group_by(composerName) %>%
  mutate(
    sd = sd(perc)
  ) %>%
  distinct(composerName,sd) %>%
  arrange(-sd) %>%
  head(50) %>%
  ggplot() +
  geom_point(aes(sd,composerName))
```

```{r}
top50sd <- ccseason %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(totalSeason = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / totalSeason) %>%
  group_by(composerName) %>%
  mutate(
    sd = sd(perc)
  ) %>%
  distinct(composerName,sd) %>%
  arrange(-sd) %>%
  head(50)

ccseason %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(totalSeason = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / totalSeason) %>%
  ungroup() %>%
  anti_join(top50sd, by = "composerName") %>%
ggplot(aes(seasonN, perc, color = composerName)) +
  geom_line(alpha = 1/2, show.legend = FALSE)
```

```{r}
ccseason %>%
  group_by(seasonN,composerName) %>%
  count() %>%
  group_by(seasonN) %>%
  mutate(totalSeason = sum(n)) %>%
  ungroup() %>%
  mutate(perc = n / totalSeason) %>%
  ungroup() %>%
  anti_join(top50sd, by = "composerName") %>%
ggplot(aes(seasonN, perc, color = composerName)) +
  geom_line(alpha = 1/2, show.legend = FALSE) +
  coord_cartesian(xlim=c(50,75))
```
La 70ma stagione sembra essere un po' un punto di svolta.

```{r}

```





Come sono composti i repertori dei conduttori? Considero i lavori e non i movimenti.

```{r}
ccseason %>%
  group_by(conductorName,composerName) %>%
  count() %>%
  group_by(conductorName) %>%
  mutate(total = sum(n)) %>%
  mutate(perc = n / total) %>%
  ggplot() +
  geom_histogram(aes(x = perc), binwidth = 0.01, boundary = 0)

ccseason %>%
  group_by(conductorName,composerName) %>%
  count() %>%
  group_by(conductorName) %>%
  mutate(total = sum(n)) %>%
  mutate(perc = n / total) %>%
  ungroup() %>%
  count(cut_width(perc, 0.01, boundary = 0))

ccseason %>%
  group_by(conductorName,composerName) %>%
  count() %>%
  group_by(conductorName) %>%
  mutate(total = sum(n)) %>%
  mutate(perc = n / total) %>%
  ungroup() %>%
  pull(perc) %>%
  quantile(na.rm = TRUE)


```

Chi si è concentrato soprattutto su un solo autore? Escludendo chi ha condotto solo opere di un autore.

```{r}
ccseason %>%
  group_by(conductorName,composerName) %>%
  count() %>%
  group_by(conductorName) %>%
  mutate(total = sum(n)) %>%
  mutate(perc = n / total) %>%
  filter(perc > 0.5 & perc < 1) %>%
  arrange(-perc)
```

```{r}
ccseason %>%
  group_by(conductorName,composerName) %>%
  count() %>%
  group_by(conductorName) %>%
  mutate(total = sum(n)) %>%
  mutate(perc = n / total) %>%
  filter(perc == 1) %>%
  arrange(-total)
```

numero di rappresentazioni per stagione

```{r}
ccseason %>%
  group_by(seasonN) %>%
  count() %>%
  ggplot(aes(seasonN,n)) +
  geom_point()

#filtro quelle che stanno sopra le 200 rappresentazioni

over200 <- ccseason %>%
  group_by(seasonN) %>%
  count() %>%
  filter(n > 200) %>%
  select(seasonN)

```



Come sono evoluti i repertori dei direttori nel corso degli anni?
LAVORANDO SU NUMERO RAPPRESENTAZIONI

```{r}
ccseason %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  inner_join(over200) %>%
  group_by(seasonN,conductorName,composerName) %>%
  count() %>%
  group_by(seasonN,conductorName) %>%
  mutate(condRep = sum(n)) %>%
  ungroup() %>%
  mutate(percComp = n / condRep) %>%
  group_by(conductorName,composerName) %>%
  mutate(compSeasons = n_distinct(seasonN)) %>%
  ggplot(aes(seasonN,percComp,color=conductorName)) +
  geom_line(alpha = 1/2, show.legend = FALSE)
```

```{r}
ncp <- ccseason %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  inner_join(over200) %>%
  group_by(seasonN,conductorName,composerName) %>%
  count() %>%
  group_by(seasonN,conductorName) %>%
  mutate(condRep = sum(n)) %>%
  ungroup() %>%
  mutate(percComp = n / condRep) %>%
  group_by(conductorName,composerName) %>%
  mutate(compSeasons = n_distinct(seasonN)) %>%
  filter(compSeasons >= 5) %>%
  ungroup()

ncp_nested <- ncp %>%
  group_by(conductorName,composerName) %>%
  nest()

model_ncp <- function(df) {
  lm(n ~ seasonN, data = df)
}

nested_ncp_models <- 
  ncp_nested %>%
  mutate(model = map(data, model_ncp))
```

Modelli crescenti.

```{r}
up_ncp <- nested_ncp_models %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN") %>%
  arrange(estimate > 0) %>%
  arrange(-estimate) %>%
  head(10)

ncp %>%
  inner_join(up_ncp) %>%
  ggplot(aes(seasonN,n,color=composerName)) +
  geom_line() +
  geom_point(aes(seasonN,n))
```

Modelli decrescenti

```{r}
down_ncp <- nested_ncp_models %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN") %>%
  filter(estimate < 0) %>%
  arrange(estimate) %>%
  head(10)

ncp %>%
  inner_join(down_ncp) %>%
  ggplot(aes(seasonN,n,color=composerName)) +
  geom_line() +
  geom_point(aes(seasonN,n))
```

```{r}
nested_ncp_models %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN") %>%
  filter(estimate > -0.1) %>%
  filter(estimate < 0.1) %>%
  head(30) %>%
  inner_join(ncp) %>%
  ggplot(aes(seasonN,n,color=composerName)) +
  geom_line() +
  geom_point(aes(seasonN,n))
```

Lavoro sulle percentuali.

```{r}
ncp_nested_2 <- ncp %>%
  group_by(conductorName,composerName) %>%
  nest()

model_ncp_2 <- function(df) {
  lm(percComp ~ seasonN, data = df)
}

nested_ncp_models_2 <- 
  ncp_nested_2 %>%
  mutate(model = map(data, model_ncp_2))
```

Modelli crescenti.

```{r}
up_ncp_2 <- nested_ncp_models_2 %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN") %>%
  arrange(estimate > 0) %>%
  arrange(-estimate) %>%
  head(10)

ncp %>%
  inner_join(up_ncp_2) %>%
  ggplot(aes(seasonN,percComp,color=conductorName)) +
  geom_line() +
  geom_point(aes(seasonN,percComp))
```

Modelli decrescenti.

```{r}
down_ncp_2 <- nested_ncp_models_2 %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN") %>%
  filter(estimate < 0) %>%
  arrange(estimate) %>%
  head(10)

ncp %>%
  inner_join(down_ncp_2) %>%
  ggplot(aes(seasonN,percComp,color=conductorName)) +
  geom_line() +
  geom_point(aes(seasonN,percComp))
```

Vedo distribuzione

```{r}
nested_ncp_models_2 %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN") %>%
  ggplot() +
  geom_histogram(aes(estimate))
```

modelli sostanzialmente stabili

```{r}
stab_ncp_2 <- nested_ncp_models_2 %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN") %>%
  filter(estimate < 0.01) %>%
  filter(estimate > -0.01)

ncp %>%
  inner_join(stab_ncp_2) %>%
  ggplot(aes(seasonN,percComp,color=conductorName)) +
  geom_line() +
  geom_point(aes(seasonN,percComp))


```

```{r}

nested_ncp_models_2 <- nested_ncp_models_2 %>% 
  mutate(data = map2(data, model, add_residuals))

nested_ncp_models_2 <- nested_ncp_models_2 %>% 
  mutate(glance = map(model, broom::glance))
```

```{r}
glance <- unnest(nested_ncp_models_2, glance)

```

```{r}

models_ncp2 <- nested_ncp_models_2 %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model))

glancem <- unnest(models_ncp2,glance,names_sep = ".")

glancem %>%
  filter(glance.r.squared > 0.75) %>%
  filter(term == "seasonN") %>%
  arrange(-estimate) %>%
  head(10)

glancem %>%
  filter(glance.r.squared > 0.75) %>%
  filter(term == "seasonN") %>%
  arrange(estimate) %>%
  head(10)

glancem %>%
  filter(glance.r.squared > 0.75) %>%
  filter(term == "seasonN") %>%
  filter(estimate < 0.01) %>%
  filter(estimate > -0.01) %>%
  head(10)


```





Modelli che fittano bene

```{r}
overzerofive <- glance %>% 
  arrange(-r.squared) %>%
  filter(r.squared >= 0.5) %>%
  select(conductorName,composerName)

good <- glance %>% 
  arrange(-r.squared) %>%
  head(10) %>%
  select(conductorName,composerName)
```

Modelli che fittano male.

```{r}
underzerofive <- glance %>% 
  arrange(-r.squared) %>%
  filter(r.squared <= 0.5) %>%
  select(conductorName,composerName)

bad <- glance %>% 
  arrange(r.squared) %>%
  head(10) %>%
  select(conductorName,composerName)
  
```

```{r}
glance %>%
  select(r.squared) %>%
  ggplot(aes(r.squared)) +
  geom_histogram()
```




```{r}
ncp %>%
  inner_join(bad) %>%
  ggplot(aes(seasonN, percComp, color = conductorName)) +
  geom_line()
```

```{r}
performances <- performances %>%
  filter(orchestra == "New York Philharmonic")
```



```{r}
ccn <- performances %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  group_by(seasonN,conductorName,composerName) %>%
  count() %>%
  group_by(seasonN,conductorName) %>%
  mutate(condRep = sum(n)) %>%
  ungroup() %>%
  group_by(conductorName,composerName) %>%
  mutate(seasons = n_distinct(seasonN)) %>%
  ungroup()

nested_ccn <- ccn %>%
  group_by(conductorName, composerName) %>%
  nest()

ccn_models <- nested_ccn %>%
  mutate(models = map(data, ~ glm(cbind(n, condRep) ~ seasonN, ., family = "binomial")))

ccn_slopes <- ccn_models %>%
  mutate(models = map(models, tidy)) %>%
  unnest(cols = c(models)) %>%
  filter(term == "seasonN") %>%
  mutate(adjusted.p.value = p.adjust(p.value))

ccn_slopes %>%
  filter(composerName == "Mendelssohn, Felix")
```

```{r}
up_slopes <-
  ccn_slopes %>%
  filter(p.value < 0.05) %>%
  arrange(-estimate) %>%
  select(conductorName,composerName) %>%
  mutate(type = "UP")
```

```{r}
down_slopes <-
  ccn_slopes %>%
  filter(p.value < 0.05) %>%
  arrange(estimate) %>%
  select(conductorName,composerName) %>%
  mutate(type = "DOWN")
```

```{r}
updown <- bind_rows(up_slopes,down_slopes)
```

```{r}
ccn %>%
  filter(seasonN > 50 & seasonN < 100) %>%
  filter(composerName == "Wagner, Richard") %>%
  inner_join(
    up_down
  ) %>%
  ggplot(aes(seasonN,n/condRep)) +
  geom_point() +
  facet_wrap(~conductorName)

ccn %>%
  filter(conductorName == "Bergmann, Carl") %>%
  filter(composerName == "Mendelssohn, Felix") %>%
  ggplot(aes(seasonN,n/condRep,color=composerName)) +
  geom_point() +
  facet_wrap(~conductorName)
```

```{r}
ccn %>%
filter(seasonN > 0 & seasonN < 75) %>%
  inner_join(
    ccn_slopes %>%
      filter(composerName == "Weber, Carl Maria Von")
  ) %>%
  ggplot(aes(seasonN,n/condRep)) +
  geom_line() +
  facet_wrap(~conductorName)
```

```{r}

prova <- ccn_models %>%
  mutate(models = map(models, tidy)) %>%
  unnest(cols = c(models)) %>%
  filter(term == "seasonN") %>%
  mutate(adjusted.p.value = p.adjust(p.value)) %>%
  unnest(glance)

prova$data [[1]]

```


```{r}
ccn %>%
  filter(conductorName == "Toscanini, Arturo") %>%
  left_join(updown) %>%
  ggplot(aes(seasonN,n/condRep,color=composerName)) +
  geom_line(alpha = 1/2,show.legend = FALSE)
```



```{r}
ccn_models <- ccn_models %>% 
  mutate(data = map2(data, models, spread_residuals))

ccn_models <- ccn_models %>% 
  mutate(glance = map(models, broom::glance))

glance <- unnest(ccn_models,glance)

glance <-
  glance %>%
  mutate(rsq = 1 - (deviance/null.deviance))

best <- glance %>%
  arrange(-rsq) %>%
  filter(rsq >= 0.75) %>%
  select(conductorName,composerName)

worst <- glance %>%
  filter(rsq <= 0.75) %>%
  arrange(rsq) %>%
  select(conductorName,composerName)

bestloglik <- glance %>%
  arrange(-logLik) %>%
  head(20) %>%
  select(conductorName,composerName)

```

```{r}
ggplot(glance) +
  geom_histogram(aes(rsq))
```


```{r}
ccn %>%
  inner_join(bestloglik, by = c("conductorName", "composerName")) %>%
  ggplot(aes(seasonN, n/condRep, color = conductorName)) +
  geom_line(alpha = 1/3) +
  labs(x = NULL, y = "Perc")
```

```{r}
ccn %>%
  inner_join(worst, by = c("conductorName", "composerName")) %>%
  ggplot(aes(seasonN, n/condRep, color = conductorName)) +
  geom_line(alpha = 1/3, show.legend = FALSE) +
  labs(x = NULL, y = "Perc")
```










```{r}

```


















```{r}
perctime <- ccseason %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  select(seasonN,conductorName,workTitle,concertID,composerName)
  

ccseason %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  group_by(seasonN,conductorName,composerName) %>%
  count() %>%
  group_by(seasonN,conductorName) %>%
  mutate(condRep = sum(n)) %>%
  ungroup() %>%
  
    
    




  count(conductorName,composerName) %>%
  group_by(seasonN,conductorName) %>%
  mutate(total = sum(n)) %>%
  mutate(perc = n / total) %>%
  filter(perc < 1) %>%
  group_by(conductorName,composerName) %>%
  mutate(compSeasons = n_distinct(seasonN)) %>%
  ungroup() 

#  %>%
#  filter(compSeasons >=5)

nested_pt <- perctime %>%
  group_by(conductorName,composerName) %>%
  nest()

modelf <- function(df) {
  lm(perc ~ seasonN, data = df)
}

nested_pt_models <- 
  nested_pt %>%
  mutate(model = map(data, modelf))

top <- nested_pt_models %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN") %>%
  arrange(estimate > 0) %>%
  arrange(-estimate) %>%
  head(20)

perctime %>%
  inner_join(top, join_by("composerName","conductorName")) %>%
  ggplot(aes(seasonN, perc, color = composerName)) +
  geom_line() +
  facet_wrap(~conductorName)
```

```{r}
bot <- nested_pt_models %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "seasonN") %>%
  filter(estimate < 0) %>%
  arrange(estimate) %>%
  head(20)

perctime %>%
  inner_join(bot, join_by("composerName","conductorName")) %>%
  ggplot(aes(seasonN, perc, color = composerName)) +
  geom_point() +
  facet_wrap(~conductorName)
```

```{r}
perctime %>%
  filter(conductorName == "Harding, Daniel") %>%
  ggplot() +
  geom_col(aes(x = seasonN, y = perc, fill = composerName))

perctime %>%
  filter(conductorName == "Muti, Riccardo")

perctime %>%
  inner_join(bot, join_by("composerName","conductorName")) %>%
  filter(conductorName == "Mahler, Gustav") %>%
  ggplot() +
  geom_col(aes(x = seasonN, y = perc, fill = composerName))

bot

perctime %>%
  inner_join(bot, join_by("composerName","conductorName")) %>%
  group_by(conductorName,composerName) %>%
  mutate(seasons = max(seasoN) - min(seasonN) + 1) %>%
  arrange(-seasons) %>%
  ungroup() %>%
  ggplot(aes(seasonN, perc, color = composerName)) +
  geom_point() +
  facet_wrap(~conductorName)


```

```{r}
perctime %>%
  filter(conductorName == "Slatkin, Leonard") %>%
  ggplot() +
  geom_point(aes(x = seasonN, y = perc, color = composerName))
```

```{r}
perctime %>%
  filter(conductorName == "Masur, Kurt") %>%
  ggplot() +
  geom_point(aes(x = seasonN, y = perc, color = composerName))
```

```{r}
perctime %>%
  filter(conductorName == "Boulez, Pierre") %>%
  ggplot() +
  geom_point(aes(x = seasonN, y = perc, color = composerName))
```


```{r}
perctime_2 <- ccseason %>%
  filter(!is.na(conductorName)) %>%
  filter(conductorName != "Not conducted") %>%
  mutate(year = year(Date)) %>%
  group_by(year) %>%
  count(conductorName,composerName) %>%
  group_by(year,conductorName) %>%
  mutate(total = sum(n)) %>%
  mutate(perc = n / total) %>%
  group_by(conductorName,composerName) %>%
  mutate(compYears = n_distinct(year)) %>%
  mutate(year_2 = year**2) %>%
  ungroup() %>%
  filter(compYears >=5)

nested_pt_2 <- perctime_2 %>%
  group_by(conductorName,composerName) %>%
  nest()

modelf2 <- function(df) {
  lm(perc ~ year + year_2, data = df)
}

nested_pt_models_2 <- 
  nested_pt_2 %>%
  mutate(model = map(data, modelf2))

top <- nested_pt_models_2 %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "year_2") %>%
  filter(p.value < 0.05) %>%
  arrange(-estimate) %>%
  head(10)

bot <- nested_pt_models_2 %>%
  mutate(model = map(model,tidy)) %>%
  unnest(cols = c(model)) %>%
  filter(term == "year_2") %>%
  filter(p.value < 0.05) %>%
  arrange(estimate) %>%
  head(10)

```

```{r}
perctime %>%
  inner_join(top, join_by("composerName","conductorName")) %>%
  ggplot(aes(year, perc, color = composerName)) +
  geom_line() +
  facet_wrap(~conductorName)
```












































































Quanti programmi ci sono nel dataset?

```{r}
prova %>% group_by(Time) %>% count(sort = TRUE)

prova %>% group_by(Location) %>% count(sort = TRUE)

prova %>% filter(programID == 13158)
```



La colonna "interval" contiene intermission di vari tipi.

```{r}
intervalNA <- programsT %>%
  filter(!is.na(interval)) %>%
  count()

intervalNome <- programsT %>%
  filter(str_detect(interval, "Intermission")) %>%
  count()
  
intervalNA == intervalNome
```

Compositori & direttori.

```{r}
cc <- programsT %>%
  filter(is.na(interval)) %>%
  distinct(concertID, Date, composerName, workTitle, conductorName)
  
cc %>%
  group_by(conductorName) %>%
  n_distinct(Date)

cc %>%
  filter(is.na(composerName))
  
programsT %>%
  filter(concertID == 577)
```

```{r}

```



Primo e ultimo concerto per direttori. Densità di concerti.

```{r}
ccn <- cc %>%
  filter(!is.na(conductorName), conductorName != "Not conducted") %>%
  distinct(concertID,conductorName) %>%
  group_by(conductorName) %>%
  count()

cc %>%
  filter(!is.na(conductorName), conductorName != "Not conducted") %>%
  group_by(conductorName) %>%
  summarise (
    first = min(Date),
    last = max(Date),
    span = last - first + 1
  ) %>%
  inner_join(ccn) %>%
  mutate(c2d = n / as.integer(span)) %>%
  arrange(-c2d,-n)

cc %>%
  filter(conductorName == "Abbado, Roberto") 

cc %>%
  filter(conductorName == "Ravel, Maurice")

cc %>%
  filter(conductorName == "Alsop, Marin")

```

Primi cinquanta compositori per numero di concerti.

```{r}
ct50 <- cc %>%
  distinct(concertID, composerName) %>%
  group_by(composerName) %>%
  count() %>%
  arrange(-n) %>%
  select(composerName) %>%
  head(50)

cc %>%
  distinct(concertID,Date,composerName) %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month,monthid,composerName) %>%
  count() %>%
  inner_join(ct50,join_by(composerName)) %>%
  ggplot() +
  geom_tile(aes(x=reorder(month,monthid),y=composerName,fill=n))
```

Compositori che sono particolarmente rappresentati in un certo mese.
Globalmente, considerando i lavori rappresentati, sulla base della percentuale all'interno del mese.

```{r}
cc %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  mutate(percent = totalC / totalM) %>%
  filter(percent > 0.01) %>%
  ggplot() +
    geom_tile(aes(x=reorder(month,monthid),y=composerName,fill=percent))
```

George Gershwin.

```{r}
cc %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  mutate(percent = totalC / totalM) %>%
  filter(composerName == "Gershwin,  George")
  
cc %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  mutate(percent = totalC / totalM) %>%
  filter(composerName == "Gershwin,  George") %>%
  ggplot() +
    geom_point(aes(x=reorder(month,monthid),y=percent))
```

Beethoven.

```{r}
cc %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  mutate(percent = totalC / totalM) %>%
  filter(composerName == "Beethoven,  Ludwig  van") %>%
  ggplot() +
    geom_point(aes(x=reorder(month,monthid),y=percent))

```

Inizio e fine delle subscription season.

```{r}
programsT %>%
  filter(eventType == "Subscription Season") %>%
  group_by(season) %>%
  mutate(
    start = min(Date),
    end = max(Date)
  ) %>%
  ggplot() +
  geom_point(aes(x=season,y=month(start), color="red")) +
  geom_point(aes(x=season,y=month(end), color="blue"))

```


Concentrandomi sulla subscription season.

```{r}

  
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  mutate(percent = totalC / totalM) %>%
  filter(percent > 0.01) %>%
  ggplot() +
    geom_tile(aes(x=reorder(month,monthid),y=composerName,fill=percent))

```

Beethoven.

```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  mutate(percent = totalC / totalM) %>%
  filter(composerName == "Beethoven,  Ludwig  van") %>%
  ggplot() +
    geom_point(aes(x=reorder(month,monthid),y=percent))
```

```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  filter(as.integer(month(Date)) == 8) %>%
  filter(composerName == "Beethoven,  Ludwig  van") %>%
  ggplot() +
  geom_point(aes(x=Date,y=))
```

Subscription Season con normalizzazione.

```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  ungroup() %>%
  group_by(month) %>%
  mutate(
    normalized = (totalC - min(totalC)) / (max(totalC) - min(totalC))
  ) %>%
  distinct(composerName,month,monthid,normalized) %>%
  filter(normalized > 0.2) %>%
  ggplot() +
    geom_tile(aes(x=reorder(month,monthid),y=composerName,fill=normalized))
```

Globale con normalizzazione.

```{r}
ccseason %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  ungroup() %>%
  group_by(month) %>%
  mutate(
    normalized = (totalC - min(totalC)) / (max(totalC) - min(totalC))
  ) %>%
  distinct(composerName,month,monthid,normalized) %>%
  filter(normalized > 0.2) %>%
  ggplot() +
    geom_tile(aes(x=reorder(month,monthid),y=composerName,fill=normalized))
```

Diverso da subscription con normalizzazione.

```{r}

ccseason %>%
  filter(eventType != "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  ungroup() %>%
  group_by(month) %>%
  mutate(
    normalized = (totalC - min(totalC)) / (max(totalC) - min(totalC))
  ) %>%
  distinct(composerName,month,monthid,normalized) %>%
  filter(normalized > 0.2) %>%
  ggplot() +
    geom_tile(aes(x=reorder(month,monthid),y=composerName,fill=normalized))

```


```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  group_by(month) %>%
  mutate(totalM = n()) %>%
  group_by(composerName,add=TRUE) %>%
  mutate(totalC = n()) %>%
  filter(monthid == 5) %>%
  distinct(composerName,totalC) %>%
  arrange(-totalC)
```

```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(month = format(Date, "%B"), monthid = as.integer(month(Date))) %>%
  filter(monthid == 7)
```




```{r}
ccseason %>%
  filter(eventType == "Subscription Season") %>%
  mutate(Year = year(Date)) %>%
group_by(Year,composerName) %>%
  count() %>%
ggplot(aes(Year, n, color = composerName)) +
  geom_line(alpha = 1/2, show.legend = FALSE)
```




